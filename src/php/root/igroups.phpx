<?php
	//#==================================================================
	//# I-Group Details and Roster Query and Management
	//#------------------------------------------------------------------
	//# MKP-USA I-Group Portal
	//# Formerly Warrior Information Center (WIC)
	//# Jerry Bowes, MKP-USA IT Development Coordinator, 2010-2011
	//# Jerry Bowes, MKP-USA I-Group Council Vice-Chairman, 2011-2013
	//#------------------------------------------------------------------
	//# $URL$
	//# $Rev$
	//# $Date: 2013/04/15 14:32:15 $
	//# $Id: igroups.phpx,v 1.37 2013/04/15 14:32:15 jbowes Exp $
	//# $Source: /home/jbowes/igroupportal/src/php/root/RCS/igroups.phpx,v $
	//#------------------------------------------------------------------
	//# SET EDITOR FOR 4 space TAB stops
	//# :set autoindent tabstop=4 showmatch	 (vi)
	//#==================================================================
	//#------------------------------------------------------------------
	//# To Edit subversion controlled version
	//#------------------------------------------------------------------
	//# Check out the subversion igroupportal web content directory
	//# % cd /tmp 
	//# % svn co http://svn.mkp.org/repo/igroupportal/httpdocs
	//# -or, locally on MKP1-
	//# % svn co file:///home/subversion/repo/igroupportal/httpdocs
	//#
	//# % cd /tmp/httpdocs
	//# % vi (thisfile)
	//# % svn ci [-m'<message describing change>'] (thisfile)
	//#------------------------------------------------------------------
	//# Deploy as root on mkp1
	//#------------------------------------------------------------------
	//# % cd /var/httpdocs/vhosts/igroupportal.mkp.org/httpdocs
	//# % svn update
	//# % chown -R igroupportalweb.psacln *.php
	//#==================================================================
	//#------------------------------------------------------------------
	require_once('./include/looknfeel-inc.phpx');
	require_once('./include/msutils-inc.phpx');
	require_once('./include/config-inc.phpx');
	require_once('./include/session-inc.phpx');
	require_once('./include/nav-inc.phpx');

	//------------------------------------------------------------------------
	// START AUTH: If you are not authenticated, on to login you go
	//------------------------------------------------------------------------
	session_start();
	global $WICCFG;

	if ( ! isset ( $_SESSION['war_id'] )) {
		$url = preg_replace('/&/','|', $_SERVER['QUERY_STRING']);
		$returl = $_SERVER['PHP_SELF'];
		if (! empty ($url) ) {
			$returl .= '?' . $url;
		}
		header("Location: $WICCFG[SECWICURL]/login.phpx?RetUrl=${returl}");
		exit;
	}
	//------------------------------------------------------------------------
	// END AUTH: 
	//------------------------------------------------------------------------

	//------------------------------------------------------------------------
	// Look and feel
	//------------------------------------------------------------------------
	$FMT = array (
		'BANNER'	=>	'MKP I-Groups',
		'TITLE'		=>	'MKP I-Groups',
		'NAV1'		=>	'IGROUPS'
	);

	$IGCFG = array (
		'MINNONE'		   =>  '100',  // Min I-Group ID of 'None: ...' I-groups
		'MAXNONE'		   =>  '159',  // Max I-Group ID of 'None: ...' I-groups
		'EDITLEVEL'			=>	'4',
		'ADMINLEVEL'		=>	'7'
	);

	$REGFIELD = array(
		'igrpreg_id',
		'igrpreg_name',
		'igrpreg_cen'
	);

	$IGROUPFIELD = array(
		//'igroup_id',
		'igroup_name',
		'location_id',
		'igroup_title',
		'igroup_status',
		'igroup_cen',
		'igroup_reg',
		//'igroup_street',  // Legacy for old igroups
		//'igroup_city',	// Legacy for old igroups
		//'igroup_state',   // Legacy for old igroups
		//'igroup_country', // Legacy for old igroups
		//'igroup_zip',	 	// Legacy for old igroups
		'igroup_frequency',
		'igroup_night',
		'igroup_mixed',
		'igroup_newmembers',
		'igroup_rep',
		'igroup_time',
		'igroup_visit_initiated',
		'igroup_visit_uninitiated',
		'igroup_history'
	);

	$ALLFIELD = array(
		'igroup_id',
		'igroup_name',
		'location_id',
		'igroup_title',
		'igroup_status',
		'igroup_cen',
		'igroup_reg',
		//'location_city',			// Legacy for old igroups
		//'location_state',			// Legacy for old igroups
		//'igroup_street',		 	// Legacy for old igroups
		//'igroup_city',			// Legacy for old igroups
		//'igroup_state',		  	// Legacy for old igroups
		//'igroup_country',			// Legacy for old igroups
		//'igroup_zip',				// Legacy for old igroups
		'igroup_frequency',
		'igroup_night',
		'igroup_mixed',
		'igroup_newmembers',
		'igroup_rep',
		'igroup_time',
		'igroup_visit_initiated',
		'igroup_visit_uninitiated',
		'center_id',
		'location_description',
		'location_city',
		'location_county',
		'location_street',
		'location_type',
		'location_url',
		'map_url',
		'contact_id',
		'location_capacity',
		'contact_name',
		'contact_phone',
		'contact_email',
		'driving_directions',
		'location_latitude',
		'location_longitude',
		'location_notes',
		'igroup_history'
	);

	$SHOW = array(
		'igroup_name',
		'igroup_cen',
		'location_id',
		'igroup_status',
		'igroup_reg',
		'location_state',
		'location_id',
		'igroup_frequency',
		'igroup_mixed',
		'igroup_newmembers',
		'igroup_night',
		'igroup_visit_initiated',
		'igroup_visit_uninitiated',
		'location_zip'
	);
	$SHOWREPS = array(
		'igroup_name',
		'igroup_cen',
		'location_id',
		'igroup_rep',
		'igroup_frequency',
		'war_hphone',
		'war_cphone',
		'igroup_night'
	);

	// Fields that can have query drill down links on display
	$LINK = array(
		'igroup_cen',
		'location_city',
		'igroup_country',
		'igroup_mixed',
		'igroup_newmembers',
		'igroup_night',
		'igroup_frequency',
		'igroup_reg',
		'location_state',
		'location_country',
		'location_id',
		'igroup_status',
		'igroup_visit_initiated',
		'igroup_visit_uninitiated',
		'location_zip'
	);

	// Required for New Entry
	$RequiredField = array(
		'igroup_name'		=>		'enter name of I-Group',  
		'igroup_cen'		=>		'select center',
		'location_id'		=>		'enter location, or query from <A HREF=/fulllocation.php>location menu</A>',
		'igroup_frequency'	=>		'enter frequency of meeting',
		'igroup_mixed'		=>		'select whether this I-Group is men only or mixed gender (MI-Group)',
		'igroup_newmembers'	=>		'select whether open to new members',
		'igroup_night'		=>		'enter night of week I-Group meets',
		'igroup_reg'		=>		'select I-Group region',
		'igroup_rep'		=>		'select I-Group rep (must have logged in to appear on selection list)',
		'igroup_status'		=>		'select status of I-Group',
		'igroup_time'		=>		'enter time your I-Group meets',
		'igroup_visit_initiated'	=>		'select whether you invite initiated men to visitor',  
		'igroup_visit_uninitiated'	=>		'select whether you invite uninitiated people to visit'
	);
	//
	// Global query choices
	//
	$InValidChoice = array(
		'All',
		'None',
		'',
		' ',
		'Choose'
	);
	//
	// Edit record fields with edit disabled
	//
	$NoEdit = array(
		'igroup_id',
		'center_id'
	);
	//
	$FieldType = array(
		'center_id'					=>	'MenuArray',
		'igroup_newmembers'			=>	'Menu',
		'igroup_mixed'				=>	'Menu',
		'igroup_rep'				=>	'RepMenu',
		'igroup_frequency'			=>	'Menu',
		'igroup_status'				=>	'Menu',
		'igroup_visit_uninitiated'	=>	'Menu',
		'igroup_visit_initiated'	=>	'Menu',
		'igroup_night'				=>	'Menu',
		'location_id'				=>	'MenuArray',
		'igroup_newmembers'			=>	'Menu',
		'igroup_history'			=>	'TextArea',
		'igroup_cen'				=>	'MenuArray',
		'location_id'				=>	'MenuArray',
		'igroup_reg'				=>	'MenuArray',
		'location_type'				=>	'Menu'
	);
	$BASE = "SELECT choice from menu WHERE table_name = 'igroup' AND field_name = ";
	$FBASE = "SELECT choice from menu WHERE table_name = 'fulllocation' AND field_name = ";
	$Menu = array(
		'center_id'					=> "SELECT center_id, center_name from center order by center_name",
		'location_type'				=> $FBASE . "'location_type' ORDER BY field_name",
		'igroup_newmembers'			=> $BASE . "'igroup_newmembers'",
		'igroup_mixed'				=> $BASE . "'igroup_mixed'",
		'igroup_frequency'			=> $BASE . "'igroup_frequency'",
		'igroup_night'				=> $BASE . "'igroup_night'",
		'igroup_status'				=> $BASE . "'igroup_status'",
		'igroup_visit_initiated'	=> $BASE . "'igroup_visit_initiated'",
		'igroup_visit_uninitiated'	=> $BASE . "'igroup_visit_uninitiated'",
		'igroup_cen' 				=> 'SELECT DISTINCT center_id, short_name from center ORDER BY short_name',
		'location_name' 			=> "SELECT DISTINCT location_name from fulllocation WHERE location_type = 'Small Group' OR location_typ = 'Residence' ORDER BY location_name",
		'location_id' 				=> "SELECT DISTINCT location_id, location_name from fulllocation WHERE location_type = 'Small Group' OR location_type = 'Residence' ORDER BY location_name",
		'igroup_reg' 				=> 'SELECT DISTINCT igrpreg_id, igrpreg_name from igroup_regions ORDER BY igrpreg_name'
	);

	//
	// Display exceptions from default tdcs centered display table cell
	//
	$JustifyCss = array(
		'location_id'	=>	'tds',	// small left justified
		'igroup_name'	=>	'tds',	// small left justified
		'location_city'	=>	'tds',	// small left justified
		'igroup_reg'	=>	'tds'	// small left justified
	);

	//--------------------------------------------------------------------------
	// Begin, Set Up Google Maps
	//--------------------------------------------------------------------------

	if (array_key_exists('Action', $_REQUEST)) {
	  	if ($_REQUEST['Action'] == "I-Groups Near Me" 
			|| $_REQUEST['Action'] == "Men Near My I-Group" ) {
			//--------------------------------------------------------------------------
			// Iniitate Maps
			//--------------------------------------------------------------------------
			caa_connect();

	  		if ($_REQUEST['Action'] == "I-Groups Near Me" ){

				if (isset ($_SESSION['war_id'] ) ) {
					$sql = "SELECT war_zip from warrior where war_id = '$_SESSION[war_id]'";
					$FMT['IGMAPS'] = get_value($sql);
					$FMT['SQL'] = $sql;	// DEVONLY
				}else{
					die("NO War_id in SESSION, need to log in.\n");
				}

				spew_header($FMT);
				echo "<PRE>\n"; // DEVONLY
				echo "FMT: \n";	// DEVONLY
				print_r($FMT); // DEVONLY
				echo "REQUEST: \n";	// DEVONLY
				print_r($_REQUEST); // DEVONLY
				echo "</PRE>\n"; // DEVONLY
				spew_query_form();
	
				echo "<CENTER>\n";
				echo "<P class=trace>Below is a map of all I-Groups roughly within a 60 mile";
				echo " radius of your home zip code.";
				echo " <BR>(That have updated their locations with zip code, latitude, and longitude.)\n";
				echo " <BR>Green icons are I-Groups open to new members, Red icons are closed to new members.\n";
				echo " <BR>Hovering over map-pins will reveal names of I-Groups";
				echo ", clicking on them will show day, time, and more info link";
				echo ".</P>\n";

				echo "<TABLE BORDER=5>\n";
				echo "<TR><TD>\n";
				echo "<DIV id=\"map_canvas\" style=\"width: 500px; height: 500px\"></DIV>\n";
				echo "</TD>\n";
				echo "</TABLE>\n";
				echo "</CENTER>\n";
			}

	  		if ( $_REQUEST['Action'] == "Men Near My I-Group" ) {

				if ( isset ($_SESSION['igroup_id'] ) ) {
					$FMT['MIGMAPS'] = $_SESSION['igroup_id'];
				}else{
					die("No igroup ID in SESSION, need to log in.\n");
				}

				spew_header($FMT);
				echo "<PRE>\n"; // DEVONLY
				print_r($_REQUEST); // DEVONLY
				echo "</PRE>\n"; // DEVONLY
				spew_query_form();
	
				echo "<CENTER>\n";
				echo "<P class=trace>Below is a map of all NWTA initiated warriors roughly within a 60 mile";
				echo " radius of your I-Group.";
				echo " <BR>Green icons show members of I-Groups, red icons are men not currently in an I-Group";
				echo " <BR>Hovering over map-pins will reveal names";
				echo " and clicking on them will show contact information";
				echo ".</P>\n";

				echo "<TABLE BORDER=5>\n";
				echo "<TR><TD>\n";
				echo "<DIV id=\"map_canvas\" style=\"width: 500px; height: 500px\"></DIV>\n";
				echo "</TD>\n";
				echo "</TABLE>\n";

				echo "</CENTER>\n";
			}

		}else{
			spew_header($FMT);
			echo "<PRE>\n"; // DEVONLY
			print_r($_REQUEST); // DEVONLY
			echo "</PRE>\n"; // DEVONLY
			spew_query_form();
		}

		//----------------------------------------------------------------------
		// Report Summary
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "USA Summary") {
            if ( ! isset ( $_REQUEST['Sort'] )  ) {
                $_REQUEST['Sort'] = 'Center';
            }
			caa_connect();
			$fromsql = array();
			$where = array();
			$what = array();
			$row = array();
			$IgroupsPerCenter = array();
			$MenPerIgroup = array();
			$MenPerCenter = array();
			$IgroupCenter = array();
			$CenterID = array();
			$CenterName = array();
			$TotalMen = array();
			$TotalIgroups = array();
			$AvgMPIperCenter = array();
			$Sort = array();
			$VisitorsPerCenter = array();
			$VisitorsPerIgroup = array();

			//----------------------------------------------------------
			// Exclude for NON-USA, Texas, Online Virtual, etc
			//----------------------------------------------------------
			$CidReject = array (
				//'1',  //Northern California
				//'2',  //Northwest 
				'3',  //Canada West
				//'4',  //Los Angeles
				//'5',  //San Diego 
				//'6',  //New Mexico
				//'7',  //Arizona
				'8',    // Zombie
				'9',  //Houston
				//'10',  //Chicago
				'11',  //United Kingdom
				'12',  //Est Canada East
				//'13',  //New England
				//'14',  //New York Metro
				//'15',  //Philadelphia 
				//'16',  //Upstate New York
				//'17',  //Greater Washington, DC
				//'18',  //Greater Carolinas
				//'19',  //Colorado
				//'20',  //Central Plains
				//'21',  //Indiana
				'22',  //South Africa 
				'23',  //Australia 
				'24',  //Deutschland
				'25',  //Europe Francophone
				'26',   // Zombie
				//'27',  //St. Louis 
				//'28',  //Memphis
				//'29',  //Georgia
				//'30',  //Kentucky
				//'31',  //Windsor / Detroit
				//'32',  //Minnesota 
				//'33',  //Wisconsin 
				'34',   // Zombie
				'35',  //New Zealand
				'36',   // Zombie
				'37',  // Virtual Online (Formerly MKP CAA Portal)
				//'38',  //New Jersey
				'39',   // Zombie
				//'40',  //North Texas
				'41',   // Zombie
				//'42',  //New Orleans
				//'43',  //Kansas City
				//'44',  //Santa Barbara
				//'45',  //Intermountain
				//'46',  //Florida
				//'47',  //Hawaii 
				'48'  //Toronto
			);
				
			//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
			// Query and Analyze for Initiated Men
			//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

			//mysql> desc warrior_igroup;
			//+------------+------------------+------+-----+---------+----------------+
			//| Field	  | Type			 | Null | Key | Default | Extra		  |
			//+------------+------------------+------+-----+---------+----------------+
			//| war_ig_id  | int(11) unsigned | NO   | PRI | NULL	| auto_increment |
			//| war_ig_war | int(11) unsigned | NO   | MUL | 0	   |				|
			//| war_ig_ig  | int(11) unsigned | NO   | MUL | 0	   |				|
			//+------------+------------------+------+-----+---------+----------------+

			//----------------------------------------------------------
			// Calculate all men per center and sum of all men
			//----------------------------------------------------------
			$sql = "SELECT war_center, count(war_center) FROM warrior GROUP BY war_center ORDER BY war_center";
			echo "<P class=trace>$sql</P>\n";	// DEVONLY
			$AllMenPerCenter = array();
			$AllMenPerCenter = get_menu_array($sql);
			echo "<PRE>\n";				// DEVONLY
			print_r($AllMenPerCenter);	// DEVONLY
			echo "</PRE>\n";			// DEVONLY

			foreach ($AllMenPerCenter as $cid => $num) {
				//echo "<BR>AllMenPerCenter: $cid : $num\n"; // DEVONLY
				$alltotmen += $num;
                //
				// Sort on Warriors Per Center
                //
				if ( $_REQUEST['Sort'] == 'WPC' ) {
					$numkey = ( 10000 * $num ) + $numkeytiebreaker++;
					echo "<P class=trace> Setting Sort Index for WPC to $numkey for cid of $cid</P>\n"; // DEVONLY
					$Sort[$numkey] = $cid;
				}
			}
			echo "<P class=trace>All Total Initiated Men: $alltotmen</P>\n";	// DEVONLY

			//
			// Base sql query
			//
			$what = array(
				'c.center_name',
				'z.war_ig_ig',
				'z.war_ig_war',
				'i.igroup_id',
				'i.igroup_cen',
				'i.igroup_name'
			);

			$where = array(
				'c.center_id = i.igroup_cen',
				'z.war_ig_ig = i.igroup_id',
				"i.igroup_name NOT LIKE 'None:%'"
			);

			$from = array(
				'igroup'			=>	'i',
				'warrior_igroup'	=>	'z',
				'center'			=>	'c'
			);

			// Assemble SQL
			$sql = "SELECT DISTINCT " . implode(',', $what);
			foreach ($from as $table => $abbr) {
				$fromsql[] = $table . ' ' . $abbr;
			}
			$fromsql = array_unique($fromsql);

			$sql .= ' FROM ' . implode(',', $fromsql);

			if ( count($where) ) {
				$sql .= ' WHERE ' . implode(' AND ', $where);
			}
			$sql .= ' ORDER BY c.center_name, i.igroup_name ';

			echo "<P class=trace>$sql</P>\n";	// DEVONLY
			$result = mysql_query($sql);
	
			//
			// Analyze Initiated Men
			//

			while ($row = mysql_fetch_array($result, MYSQL_ASSOC) ) {
				$cid = $row['igroup_cen'];
                if (in_array($cid, $CidReject) ) {
                    continue;
                }
				$iname = $row['igroup_name'];
				$cname = $row['center_name'];
				$iid = $row['igroup_id'];
				$wid = $row['war_ig_war'];
				$IgroupCenter[$iid] = $cid;
				$CenterID[$cname] = $cid;
				$CenterName[$cid] = $cname;
				$TotalMen[$wid]++;
				$TotalIgroups[$iid]++;

				$MenPerIgroup[$iid]++;
				$MenPerCenter[$cid]++;

				if ( $iid != $last_iid ) {
					$IgroupsPerCenter[$cid]++;
				}

				if ( $cid != $last_cid ) {
                    //
                    // Default sort by Center
                    //
					if ( !isset ($_REQUEST['Sort']) || $_REQUEST['Sort'] == 'Center' ) {
						echo "<P class=trace> Setting Sort Index for Center to $cname for cid of $cid</P>\n"; // DEVONLY
						$Sort[$cname] = $cid;
					}

                    if (isset( $IgroupsPerCenter[$last_cid] ) ) {
					    $AvgMPIperCenter[$last_cid] = sprintf('%5.2f', ($MenPerCenter[$last_cid] / $IgroupsPerCenter[$last_cid]) );
                    }

                    //
					// Sort by Warriors Per Center
                    //
					if ( $_REQUEST['Sort'] == 'APC' ) {
						if ( isset ($last_cid)) {
							$wpc = ( 1000 * $MenPerCenter[$last_cid] + $mpctiebreaker++);
							echo "<P class=trace> Setting Sort Index for APC to $wpc for last cid of $last_cid</P>\n"; // DEVONLY
							$Sort[$wpc] = $last_cid;
						}
					}
                    //
					// Sort by Igroups Per Center
                    //
					if ( $_REQUEST['Sort'] == 'IGC' ) {
					    $numig = (1000 * $IgroupsPerCenter[$last_cid]) + $igrouptiebreaker++;;
						echo "<P class=trace> Setting Sort Index for IGC to $numig for cid of $cid</P>\n"; // DEVONLY
						$Sort[$numig] = $last_cid;
					}
                    //
                    // Average Men Per I-Group: ( MenPerCenter[$cid] + VisitorPerCenter[$cid] ) / $IgroupsPerCenter[$cid]
                    //
				    if ( $_REQUEST['Sort'] == 'MPG' ) {
					    if ( isset($last_cid)) {
						    echo "<P class=trace> MPG Sort Flag</P>\n"; // DEVONLY
                            if (isset( $IgroupsPerCenter[$last_cid] ) ) {
						        $mpgkey = (int)(10000 * (($MenPerCenter[$last_cid] + $VisitorsPerCenter[$last_cid]) / $IgroupsPerCenter[$last_cid]));
						        echo "<P class=trace> MPG Key: MenPerCenter ( $MenPerCenter[$last_id] ) and IPC ( $IgroupsPerCenter[$last_id] ) for last cid of $last_id  to $mpgkey </P>\n"; // DEVONLY
						        $Sort[$mpgkey] = $last_cid;
                            }
					    }
				    }
                    //
                    // Sort by Percent of Men in Centers In I-Groups
                    //
				    if ( $_REQUEST['Sort'] == 'PctMen' ) {
					    if ( isset($last_cid)) {
						    $pctmenx = (int)(10000 * ($MenPerCenter[$last_cid] / $AllMenPerCenter[$last_cid]));
						    echo "<P class=trace> PctMen Key: MenPerCenter ( $MenPerCenter[$last_cid] ) and AllMenPerCenter ( $AllMenPerCenter[$last_cid] ) for last cid of $last_cid  to $pctmenx </P>\n"; // DEVONLY
						    $Sort[$pctmenx] = $last_cid;
					    }
				    }
				}

				$last_iid = $iid;
				$last_cid = $cid;
			}
			//
			// Last Itteration Cleanup
			//
			$AvgMPIperCenter[$last_cid] = sprintf('%5.2f', ($MenPerCenter[$last_cid] / $IgroupsPerCenter[$last_cid]) );

			//
            // Average Men Per I-Group: 
			//
			if ( $_REQUEST['Sort'] == 'APC' ) {
				$wpc = ( 1000 * $MenPerCenter[$last_cid] + $mpctiebreaker++);
				$Sort[$wpc] = $last_cid;
			}
			//
		    // Sort by Igroups Per Center
			//
		    if ( $_REQUEST['Sort'] == 'IGC' ) {
			    $numig = (1000 * $IgroupsPerCenter[$last_cid]) + $igrouptiebreaker++;;
				echo "<P class=trace> Setting Sort Index for IPC to $numig for cid of $cid</P>\n"; // DEVONLY
				$Sort[$numig] = $last_cid;
			}
			//
            // Percent of men in Center sitting in I-Groups
			//
		    if ( $_REQUEST['Sort'] == 'PctMen' ) {
			    $pctmenx = (int)(10000 * ($MenPerCenter[$last_cid] / $AllMenPerCenter[$last_cid]));
			    echo "<P class=trace> PctMen Key: MenPerCenter ( $MenPerCenter[$last_cid] ) and AllMenPerCenter ( $AllMenPerCenter[$last_cid] ) for last cid of $last_cid  to $pctmenx </P>\n"; // DEVONLY
			   	$Sort[$pctmenx] = $last_cid;
		    }
			//
			// Men per I-Group
			//
		    if ( $_REQUEST['Sort'] == 'MPG' ) {
			    if ( isset($last_cid)) {
				    echo "<P class=trace> MPG Sort Flag</P>\n"; // DEVONLY
				    $mpgkey = (int)(10000 * (($MenPerCenter[$last_cid] + $VisitorsPerCenter[$last_cid]) / $IgroupsPerCenter[$last_cid]));
				    echo "<P class=trace> MPG Key: MenPerCenter ( $MenPerCenter[$last_id] ) and IPC ( $IgroupsPerCenter[$last_id] ) for last cid of $last_id  to $mpgkey </P>\n"; // DEVONLY
				    $Sort[$mpgkey] = $last_cid;
			    }
            }

			//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
			// Query and Analyze for UnInitiated People
			//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
			$from = array();
			$fromsql = array();
			$where = array();
			//mysql> desc igvisitor_igroup;
			//+---------------------+------------------+------+-----+---------+----------------+
			//| Field			   | Type			 | Null | Key | Default | Extra		  |
			//+---------------------+------------------+------+-----+---------+----------------+
			//| igvisitor_igroup_id | int(10) unsigned | NO   | PRI | NULL	| auto_increment |
			//| igvisitor_id		| int(10) unsigned | NO   |	 | NULL	|				|
			//| igroup_id		   | int(10) unsigned | NO   |	 | NULL	|				|
			//+---------------------+------------------+------+-----+---------+----------------+

			//----------------------------------------------------------
			// Calculate all visitors per center and sum of all visitors
			//----------------------------------------------------------
			$sql = "SELECT igvisitor_center, count(igvisitor_center) FROM igvisitor GROUP BY igvisitor_center ORDER BY igvisitor_center";
			echo "<P class=trace>$sql</P>\n";	// DEVONLY
			$AllVisitorsPerCenter = array();
			$AllVisitorsPerCenter = get_menu_array($sql);
			foreach ($AllVisitorsPerCenter as $cid => $num) {
				//echo "<BR>AllVistorsPerCenter: $cid : $num\n"; // DEVONLY
				$alltotvisitors += $num;
			}
			echo "<P class=trace>All Total Visitors: $alltotvisitors</P>\n";	// DEVONLY

			//
			// Base sql query
			//
			$what = array(
				'c.center_name',
				'z.igvisitor_id',
				'z.igroup_id',
				'i.igroup_id',
				'i.igroup_cen',
				'i.igroup_name'
			);
			$where = array(
				'c.center_id = i.igroup_cen',
				'z.igroup_id = i.igroup_id',
				"i.igroup_name NOT LIKE 'None:%'"
			);
			$from = array(
				'igroup'			=>	'i',
				'igvisitor_igroup'	=>	'z',
				'center'			=>	'c'
			);

			// Assemble SQL
			$sql = "SELECT DISTINCT " . implode(',', $what);
			foreach ($from as $table => $abbr) {
				$fromsql[] = $table . ' ' . $abbr;
			}
			$fromsql = array_unique($fromsql);

			$sql .= ' FROM ' . implode(',', $fromsql);

			if ( count($where) ) {
				$sql .= ' WHERE ' . implode(' AND ', $where);
			}
			$sql .= ' ORDER BY c.center_name, i.igroup_name ';

			echo "<P class=trace>$sql</P>\n";	// DEVONLY
			$result = mysql_query($sql);
	
			//
			// Analize Visitors
			//
			while ($row = mysql_fetch_array($result, MYSQL_ASSOC) ) {
				$cid = $row['igroup_cen'];
				$cname = $row['center_name'];
				$vid = $row['igvisior_id'];
				$TotalVisitors++;
				$VisitorsPerCenter[$cid]++;
				$VisitorsPerIgroup[$iid]++;
			}

			//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
			// Print Results
			//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

			echo "<CENTER>\n";
            echo "<H2>Current Active I-Group Information</H2>\n";
            echo "<P class=trace>Clicking on column headers sorts by that column. See column explanation at bottom of page.</P>\n";

            //
            // Actual Results
            //
			echo "<TABLE BORDER>\n";
			echo "<TH class=ths><A HREF=$_SERVER[PHP_SELF]?Sort=Center&Action=USA+Summary>USA Center</A></TH>\n";
			echo "<TH class=ths><A HREF=$_SERVER[PHP_SELF]?Sort=WPC&Action=USA+Summary>Warriors</A></TH>\n";
			echo "<TH class=ths><A HREF=$_SERVER[PHP_SELF]?Sort=IGC&Action=USA+Summary># I-Groups</A></TH>\n";
			echo "<TH class=ths><A HREF=$_SERVER[PHP_SELF]?Sort=APC&Action=USA+Summary># Active Warriors</A></TH>\n";
			echo "<TH class=ths># Non-Warriors</TH>\n";
			echo "<TH class=ths><A HREF=$_SERVER[PHP_SELF]?Sort=PctMen&Action=USA+Summary>%Men In I-Groups</A></TH>\n";
			echo "<TH class=ths><A HREF=$_SERVER[PHP_SELF]?Sort=MPG&Action=USA+Summary>Avg Size</A></TH>\n";

            if ( $_REQUEST['Sort'] == 'Center' ) {
			    ksort($Sort);
            }else{
			    krsort($Sort);
            }
			foreach ($Sort as $key => $cid ) {
				$cname = $CenterName[$cid];
				if ( ! in_array($cid, $CidReject ) ) {

                    if (isset ( $AllMenPerCenter[$cid] ) ) {
					    $pctmen = sprintf('%5.2f', (100 * ($MenPerCenter[$cid]  / $AllMenPerCenter[$cid] )));
                    }

					echo "<TR>\n";
					echo "<TD class=tds><A HREF=$_SERVER[PHP_SELF]?igroup_cen=$cid&Sortmeby=Name&Action=Query>$cname</TD>\n";
					echo "<TD class=tdcs>$AllMenPerCenter[$cid]</TD>\n";
					echo "<TD class=tdcs>$IgroupsPerCenter[$cid]</TD>\n";
					echo "<TD class=tdcs>$MenPerCenter[$cid]</TD>\n";
					echo "<TD class=tdcs>$VisitorsPerCenter[$cid]<BR></TD>\n";
					echo "<TD class=tdcs>$pctmen</TD>\n";
					echo "<TD class=tdcs>$AvgMPIperCenter[$cid]</TD>\n";
				}
			}
			echo "<TR>\n";
			$totmen = count(array_keys($TotalMen));
			$totig = count(array_keys($TotalIgroups));
            if ( isset ($alltotmen) ) {
			    $pctmen = sprintf('%5.2f', (100 * ($totmen  / $alltotmen )));
            }
            if ( isset ($totig) ) {
			    $totavg = sprintf('%5.2f', ($totmen / $totig) );
            }

			echo "<TD class=tdcs><B>Totals</B></TD>\n";
			echo "<TD class=tdcs><B>$alltotmen</B></TD>\n";
			echo "<TD class=tdcs><B>$totig</B></TD>\n";
			echo "<TD class=tdcs><B>$totmen</B></TD>\n";
			echo "<TD class=tdcs><B>$alltotvisitors</B></TD>\n";
			echo "<TD class=tdcs><B>$pctmen</B></TD>\n";
			echo "<TD class=tdcs><B>$totavg</B></TD>\n";

			echo "</TABLE>\n";
            //
            // Key
            //
            echo "<P>\n";
            echo "<H3>Column Explanations</H3>\n";
            echo "<TABLE BORDER Width=80%>\n";
            echo "<TH class=ths WIDTH=15%>Column</TH>\n";
            echo "<TH class=ths>Explanation</TH>\n";

            echo "<TR>\n";
            echo "<TD class=tds>USA Center</TD>\n";
            echo "<TD class=tds>\n";
            echo "USA Center. Clicking on column name sorts alphabetically.\n";
            echo "<B>Note</B>: Houston Center not included as they do not use the CAA.\n";
            echo "</TD>\n";

            echo "<TR>\n";
            echo "<TD class=tds>Warriors</TD>\n";
            echo "<TD class=tds>\n";
            echo "Number of men in CAA registered to this center.\n";
            echo "Clicking on column name sorts by center population.\n";
            echo "</TD>\n";

            echo "<TR>\n";
            echo "<TD class=tds># I-Groups</TD>\n";
            echo "<TD class=tds>\n";
            echo "Number of I-Groups in this center.\n";
            echo "Clicking on column name sorts by number of I-Groups.\n";
            echo "</TD>\n";

            echo "<TR>\n";
            echo "<TD class=tds># Active Warriors</TD>\n";
            echo "<TD class=tds>\n";
            echo "Number of men sitting in at least one active I-Group.\n";
            echo "Clicking on column name sorts by number of men sitting in I-Groups.\n";
            echo "</TD>\n";

            echo "<TR>\n";
            echo "<TD class=tds># Non-Warriors</TD>\n";
            echo "<TD class=tds>\n";
            echo "Number of non-NWTA initiated men or women regularly sitting in an I-Group.";
            echo "</TD>\n";

            echo "<TR>\n";
            echo "<TD class=tds>%Men In I-Groups</TD>\n";
            echo "<TD class=tds>\n";
            echo "Percent of men in this center that are actively sitting in at least one I-Group.\n";
            echo "Clicking on column name sorts by center participation sitting in I-Groups.\n";
            echo "</TD>\n";

            echo "<TR>\n";
            echo "<TD class=tds>Avg Size</TD>\n";
            echo "<TD class=tds>\n";
            echo "Overall average size of an I-Group in this center. Total men divided by total I-Groups for this center.\n";
            echo "Clicking on column name sorts by centers by average center size.\n";
            echo "</TD>\n";

            echo "</TABLE>\n";
            echo "<P>\n";

			echo "</CENTER>\n";
	  	}//if ($_REQUEST[Action] == "Summary")) {

		//----------------------------------------------------------------------
		// Delete I-Group
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Delete" ) {

			$igid = mysql_real_escape_string($_REQUEST['igroup_id']);

			//
			// Input Validation
			//
			if ( empty ($igid) ){
				die("ERROR: No I-Group ID Sent to delete function");
			}
			if (! is_numeric ($igid) ){
				die("ERROR: I-Group ID needs to be numeric. Contact administrator");
			}

			//
			// Permission Verification
			//
			if ( $_SESSION['access'] < $IGCFG['ADMINLEVEL'] ) {
				die("ERROR: Must have access level of $IGCFG[ADMINLEVEL] to delete an I-Group");
			}

			$today = date('Y-m-d');

			echo "<CENTER>\n";

			//------------------------------------------
			// Getting information from this I-Group
			//------------------------------------------

			$sql = "SELECT * from igroup where igroup_id = '$igid'";
			$result = mysql_query($sql);
			$Igroup = array();
			$Igroup =  mysql_fetch_array($result, MYSQL_ASSOC);
			$name = $Igroup['igroup_name'];

			if (empty($name)) {
				echo "<H3>No I-Group in the database with that ID ($igid)</H3>\n";
				spew_footer($FMT);
				exit;
			}

			echo "<H3>Collecting contents of I-Group $name (ID: $igid)</H3>\n";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY

			echo "<PRE>\n";	 // DEVONLY
			print_r($Igroup);   // DEVONLY
			echo "</PRE>\n";	// DEVONLY

			//------------------------------------------
			// Updating warrior_ighistory for members
			//------------------------------------------
			echo "<H3>Updating I-Group history for exit of each man from I-Group $name </H3>\n";

			//
			// Get Roster of men in this I-Group from warrior_igroup
			//
			$sql = "SELECT war_ig_war from warrior_igroup where war_ig_ig = '$igid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY`
			$Roster = array();
			$Roster = get_menu($sql);
			print_r($Roster); // DEVONLY

			$count = count($Roster);
			echo "<P class=trace>Count of current roster: $count</P>\n";

			//mysql> desc warrior_ighistory;
			//+--------------+------------------+------+-----+---------+----------------+
			//| Field		| Type			 | Null | Key | Default | Extra		  |
			//+--------------+------------------+------+-----+---------+----------------+
			//| ighistory_id | int(10) unsigned | NO   | PRI | NULL	| auto_increment |
			//| warrior_id   | int(10) unsigned | NO   |	 | NULL	|				|
			//| igroup_id	| int(10) unsigned | NO   |	 | NULL	|				|
			//| start_date   | date			 | YES  |	 | NULL	|				|
			//| end_date	 | date			 | YES  |	 | NULL	|				|
			//| exit_reason  | varchar(30)	  | YES  |	 | NULL	|				|
			//| exit_comment | text			 | YES  |	 | NULL	|				|
			//+--------------+------------------+------+-----+---------+----------------+

			//
			// Get roster of these men in warrior_ighistory to see if add/update required
			//
			if ($count > 0 ) {
				$sql = "SELECT warrior_id, ighistory_id FROM warrior_ighistory ";
				$sql .= " WHERE igroup_id = '$igid' ORDER BY ighistory_id";
				echo "<P class=trace>$sql</P>\n"; // DEVONLY`

				$Hist = array();
				$Hist = get_menu_array($sql);

				print_r($Hist); // DEVONLY

				foreach ($Roster as $war) {
					if ( array_key_exists($war, $Hist) ) {
						$sql = "UPDATE warrior_ighistory set "; 
						$sql .= " end_date = '$today', exit_reason = 'I-Group disbanded' ";
						$sql .= " WHERE ighistory_id = '$Hist[$war]' ";
					}else{
						$sql = "INSERT INTO warrior_ighistory (warrior_id, igroup_id, end_date, exit_reason)";
						$sql .= " VALUES ('$war','$igid','$today','I-Group disbanded')";
					}
					echo "<P class=trace>$sql</P>\n"; // DEVONLY`
					mysql_query($sql); // SAFETY
				}
			}

			//------------------------------------------
			// Removing I-Group Members from Roster
			//------------------------------------------

			//mysql> desc warrior_igroup;
			//+------------+------------------+------+-----+---------+----------------+
			//| Field	  | Type			 | Null | Key | Default | Extra		  |
			//+------------+------------------+------+-----+---------+----------------+
			//| war_ig_id  | int(11) unsigned | NO   | PRI | NULL	| auto_increment |
			//| war_ig_war | int(11) unsigned | NO   | MUL | 0	   |				|
			//| war_ig_ig  | int(11) unsigned | NO   | MUL | 0	   |				|
			//+------------+------------------+------+-----+---------+----------------+

			if ( $count > 0 ) {
				$sql = "DELETE from warrior_igroup where war_ig_id = '$igid'";
				echo "<H3>Removing members from roster of I-Group $name</H3>\n";
				echo "<P class=trace>$sql</P>\n";
				mysql_query($sql); // SAFETY
			}else{
				echo "<P class=trace>No members of this I-Group current listed in warrior_igroup</P>\n";
			}


			//------------------------------------------
			// Archiving old I-Group
			//------------------------------------------
			//
			echo "<H3>Archiving contents of I-Group $name </H3>\n";

			$fieldlabel = array();
			$fields = array();
			$fieldlabel = get_field_labels('igroup_archive','igroup');
			$fields = array_keys($fieldlabel);

			$sql = "INSERT INTO igroup_archive (";
			$sql .= implode(',', $fields);
			$sql .= ') VALUES (';
			foreach ($fields as $f ) {
				$sql .= "'" . mysql_real_escape_string($Igroup[$f]) . "'" . ",";
			}
			$sql = rtrim($sql, ',');
			$sql .= ')';

			echo "<H4>Storing contents of I-Group $name </H4>\n"; // DEVONLY
			echo "<P class=trace>$sql</P>\n"; 
			mysql_query($sql); // SAFETY

			//------------------------------------------
			// Deleting I-Group
			//------------------------------------------
			$sql = "DELETE from igroup where igroup_id = '$igid'";
			echo "<H3>Deleting I-Group $name </H3>\n";
			echo "<P class=trace>$sql</P>\n"; 
			mysql_query($sql); // SAFETY

			//------------------------------------------
			// Reminder to clean up fulllocation
			//------------------------------------------
			$lid = ($igid + 5000);
			$sql = "SELECT location_name from fulllocation where location_id = '$lid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$locname = get_value($sql);
			if ( ! empty ($locname) ) {
				echo "<H3>Please clean up location for this I-Group</H3>\n";
				echo "<P class=trace> Please check location of this I-Group and if not used by any others, please delete:";
				echo "</P>\n";
				echo "<H4><A HREF=/fulllocation.php?location_id=$lid&Action=View>$locname</A></H4>\n";
			}

			echo "</CENTER>\n";
			spew_footer($FMT);
			exit;
		}

		//----------------------------------------------------------------------
		// Designate new I-Group Rep
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Designate" ) {
			$igid = mysql_real_escape_string($_REQUEST['igroup_id']);
			$rid = mysql_real_escape_string($_REQUEST['igroup_rep']);
			if ( empty ($igid) || empty ($rid)){
				die("ERROR: To designate new rep, need I-Group ID and Rep ID. Contact administrator");
			}
			if (! is_numeric ($igid) || ! is_numeric ($rid)){
				die("ERROR: I-Group ID and Rep ID need to both be numeric. Contact administrator");
			}
			$sql = "UPDATE igroup set igroup_rep = '$rid' WHERE igroup_id = '$igid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			run_sql($sql);
			$_REQUEST['Action'] = "Manage My I-Group";
		}


		//----------------------------------------------------------------------
		// Add New Initiated Member from Query Roster
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Add Initiated Member" ) {
			caa_connect();
			$where = array();

			$igid = $_REQUEST['igroup_id'];
			$wid = $_REQUEST['warrior_id'];

			if ( empty ($igid) ){
				echo "<H2>ERROR: No I-Group ID. Contact administrator</H2>\n";
				spew_footer($FMT);
				exit;
			}
			if ( empty ($wid) ){
				echo "<H2>ERROR: No Warrior ID. Contact administrator</H2>\n";
				spew_footer($FMT);
				exit;
			}
			// SECURITY Check
			if (! is_numeric ($igid) || ! is_numeric ($wid)){
				die("ERROR: I-Group ID and Warrior ID need to both be numeric. Contact administrator");
			}
			//
			// Get I-Group Name
			//
			$sql = "SELECT igroup_name from igroup where igroup_id = '$igid'";
			$igroupname = get_value($sql);

			//
			// Get Warrior Name
			//
			$sql = "SELECT * from warrior where war_id = '$wid'";
			$result = mysql_query($sql);
			$Warrior = array();
			$Warrior =  mysql_fetch_array($result, MYSQL_ASSOC);
			$who = $Warrior['war_fname'] . ' ' . $Warrior['war_lname'];

			//mysql> desc warrior_igroup;
			//+------------+------------------+------+-----+---------+----------------+
			//| Field	  | Type			 | Null | Key | Default | Extra		  |
			//+------------+------------------+------+-----+---------+----------------+
			//| war_ig_id  | int(11) unsigned | NO   | PRI | NULL	| auto_increment |
			//| war_ig_war | int(11) unsigned | NO   | MUL | 0	   |				|
			//| war_ig_ig  | int(11) unsigned | NO   | MUL | 0	   |				|
			//+------------+------------------+------+-----+---------+----------------+
			//
			// Update warrior_igroup
			//
			$sql = "INSERT INTO warrior_igroup (war_ig_war, war_ig_ig) VALUES ('$wid','$igid')";
			$sql .= " ON DUPLICATE KEY UPDATE  war_ig_war = '$wid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql);

			//
			// Update warrior_ighistory
			//
			$today = date('Y-m-d');
			$sql = "INSERT INTO warrior_ighistory (warrior_id, igroup_id, start_date )";
			$sql .= " VALUES ('$wid','$igid','$today')";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql);

			echo "<CENTER>";
			echo "<H2>Added $who as an initiated member of $igroupname</H2>\n";
			echo "</CENTER>";

			//
			// Delete all memberships to 'None:*' igroups
			// TODO: This will stop working for men belonging to the 59th center
			//
			$sql = "DELETE from warrior_igroup WHERE war_ig_war = '$wid' ";
			$sql .= " AND war_ig_ig > '100' AND war_ig_ig < '159'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql);

	  		$_REQUEST['Action'] = "Manage My I-Group";
		}


		//----------------------------------------------------------------------
		// Add New UnInitiated Member from Query Roster
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Add UnInitiated Member" ) {
			caa_connect();
			$where = array();

			$igid = $_REQUEST['igroup_id'];
			$vid = $_REQUEST['igvisitor_id'];
			if ( empty ($igid) ){
				echo "<H2>ERROR: No I-Group ID. Contact administrator</H2>\n";
				spew_footer($FMT);
				exit;
			}
			if ( empty ($vid) ){
				echo "<H2>ERROR: No Visitor ID. Contact administrator</H2>\n";
				spew_footer($FMT);
				exit;
			}
			//
			// Get I-Group Name
			//
			$sql = "SELECT igroup_name from igroup where igroup_id = '$igid'";
			$igroupname = get_value($sql);

			//
			// Get Visitor
			//
			$sql = "SELECT * FROM igvisitor where igvisitor_id = '$vid'";
			$result = mysql_query($sql);
			$Visitor = array();
			$Visitor =  mysql_fetch_array($result, MYSQL_ASSOC);
			$who = $Visitor['igvisitor_fname'] . ' ' . $Visitor['igvisitor_lname'];

			//
			// Update igvisitor_igroup
			//
			$sql = "INSERT INTO igvisitor_igroup (igvisitor_id, igroup_id) VALUES ('$vid','$igid')";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql);

			//
			// Update igvisitor_ighistory
			//
			$today = date('Y-m-d');
			$sql = "INSERT INTO igvisitor_ighistory (igvisitor_id, igroup_id, start_date )";
			$sql .= " VALUES ('$vid','$igid','$today')";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql);

			echo "<CENTER>";
			echo "<H2>Added $who as an Non-Warrior member of $igroupname</H2>\n";
			echo "</CENTER>";

	  		$_REQUEST['Action'] = "Manage My I-Group";
		}


		//----------------------------------------------------------------------
		// Query for New Initiated Member
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "New Initiated Member" ) {
			caa_connect();
			$where = array();
			$Fieldlabel = array();

			$igid = $_REQUEST['igroup_id'];
			if ( empty ($igid) ){
				echo "<H2>ERROR: No I-Group ID. Contact administrator</H2>\n";
				spew_footer($FMT);
				exit;
			}
			$sql = "SELECT igroup_name from igroup where igroup_id = '$igid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$Name = get_value($sql);

			$Fieldlabel = get_field_labels('warrior','war');

			$sql = "SELECT war_id, war_fname, war_aname, war_lname, war_city, war_state from warrior";

			foreach ($Fieldlabel as $field => $label ) {
				if ( isset ($_REQUEST[$field]) ) {
					$val = $_REQUEST[$field];
					if ( ! empty ($val)) {
						if ( preg_match('/\%/', $val  ) ) {
							$where[] = "$field LIKE '$val'";
						}else{
							$where[] = "$field = '$val'";
						}
					}
				}
			}

			$cnt = count($where);
			if ($cnt > 0 ) {
				$sql .= ' WHERE ' . implode(' AND ', $where);
			}else{
				echo "<CENTER>\n";
				echo "<H2>No name or email provided.<BR>Please hit back \n";
				echo "button and fill out at least one entry in the\n";
				echo "<I>Add Initiated Man as New Member</I> form.\n";
				echo "</H2>\n";
				echo "</CENTER>\n";
				spew_footer($FMT);
				exit;
			}
			$sql .= " ORDER BY war_lname, war_fname ";

			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
	
			echo "<CENTER>\n";
			echo "<H2>Candidates to add to $Name I-Group</H2>\n";

			echo "<TABLE BORDER>\n";
			echo "<TH class=ths>Add</TH>\n";
			echo "<TH class=ths>First Name</TH>\n";
			echo "<TH class=ths>Last Name</TH>\n";
			echo "<TH class=ths>Animal Name</TH>\n";
			echo "<TH class=ths>City</TH>\n";
			echo "<TH class=ths>State</TH>\n";
	
			while ($row =  mysql_fetch_array($result, MYSQL_ASSOC)) {
				$wid = $row['war_id'];

				echo "<TR>\n";
	
				echo "<TD class=tdcs>";
				echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$igid&warrior_id=$wid&Action=Add+Initiated+Member>";
				//echo "<IMG SRC=/images/smallballs/greenball.gif BORDER=0></A>\n";
				echo "<B>ADD</B></A>\n";
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[war_fname]";	
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[war_lname]";	
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[war_aname]";	
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[war_city]";	
				echo "</TD>\n";
				
				echo "<TD class=tdcs>";
				echo "$row[war_state]";	
				echo "</TD>\n";
	
			}
			echo "</TABLE>\n";
			echo "<CENTER>\n";
			spew_footer($FMT);
			exit;
		}

		//----------------------------------------------------------------------
		// Query for New UnInitiated Member
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "New UnInitiated Member" ) {
			caa_connect();
			$where = array();
			$Fieldlabel = array();

			$igid = $_REQUEST['igroup_id'];
			$sql = "SELECT igroup_name from igroup where igroup_id = '$igid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$Name = get_value($sql);

			$Fieldlabel = get_field_labels('igvisitor','igvisitor');

			$sql = "SELECT igvisitor_id, igvisitor_fname, igvisitor_lname, igvisitor_city, ";
			$sql .= " igvisitor_state FROM igvisitor";

			foreach ($Fieldlabel as $field => $label ) {
				if ( isset ($_REQUEST[$field]) ) {
					$val = $_REQUEST[$field];
					if ( ! empty ($val)) {
						if ( preg_match('/\%/', $val  ) ) {
							$where[] = "$field LIKE '$val'";
						}else{
							$where[] = "$field = '$val'";
						}
					}
				}
			}
			$cnt = count($where);
			if ($cnt > 0 ) {
				$sql .= ' WHERE ' . implode(' AND ', $where);
			}else{
				echo "<CENTER>\n";
				echo "<H2>No name or email provided.<BR>Please hit back \n";
				echo "button and fill out at least one entry in the\n";
				echo "<I>Add UnInitiated Man as New Member or Visitor</I> form.\n";
				echo "</H2>\n";
				echo "</CENTER>\n";
				spew_footer($FMT);
				exit;
			}
			$sql .= " ORDER BY igvisitor_lname, igvisitor_fname ";

			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
			$count = mysql_num_rows($result);
	
			echo "<CENTER>\n";
			echo "<H2>Non-Warrior candidates to add to $Name I-Group</H2>\n";

			echo "<TABLE BORDER>\n";
			echo "<TH class=ths>Add</TH>\n";
			echo "<TH class=ths>First Name</TH>\n";
			echo "<TH class=ths>Last Name</TH>\n";
			echo "<TH class=ths>City</TH>\n";
			echo "<TH class=ths>State</TH>\n";
	
			while ($row =  mysql_fetch_array($result, MYSQL_ASSOC)) {
				$vid = $row['igvisitor_id'];
				echo "<TR>\n";
	
				echo "<TD class=tdcs>";
				echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$igid";
				echo "&igvisitor_id=$vid";
				echo "&Action=Add+UnInitiated+Member>";
				echo "<B>ADD</B></A>\n";
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[igvisitor_fname]";	
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[igvisitor_lname]";	
				echo "</TD>\n";
	
				echo "<TD class=tdcs>";
				echo "$row[igvisitor_city]";	
				echo "</TD>\n";
				
				echo "<TD class=tdcs>";
				echo "$row[igvisitor_state]";	
				echo "</TD>\n";
	
			}
			if ( $count < 1 ) {
				echo "<TR><TD class=tdcs COLSPAN=5>Not in the visitor database.";
				echo "<A HREF=/igvisitor.phpx?";
				echo "igvisitor_fname=$_REQUEST[igvisitor_fname]";
				echo "&igvisitor_lname=$_REQUEST[igvisitor_lname]";
				echo "&igvisitor_email=$_REQUEST[igvisitor_email]";
				echo "&igroup_id=$igid";
				echo "&Action=New>\n";
				echo " Add now";
				echo "</TD>\n";
			}

			echo "</TABLE>\n";
			echo "<CENTER>\n";
			if ( $count >= 1 ) {
				echo "<P class=trace>If person you are adding is not in the above list, ";
				echo "<A HREF=/igvisitor.phpx?";
				echo "&igvisitor_lname=$_REQUEST[igvisitor_lname]";
				echo "&igvisitor_email=$_REQUEST[igvisitor_email]";
				echo "&igroup_id=$igid";
				echo "&Action=New>\n";
				echo " add them now</A>.";
				echo "</P>\n";
			}
			spew_footer($FMT);
			exit;
		}

		//----------------------------------------------------------------------
		// Process Exit of Initiated Man from I-Group
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Exit" ) {
			echo "<P class=trace>Entering Exit for Initiated Men</P>\n"; // DEVONLY

			caa_connect();
			$wid = $_REQUEST['warrior_id'];
			$igid = $_REQUEST['igroup_id'];

			//
			// Display warrior_id as real name
			//
			$sql = "SELECT war_fname, war_lname from warrior where war_id = '$wid'";
			echo "<p class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
			$Warrior = array();
			$Warrior = mysql_fetch_array($result, MYSQL_ASSOC) ; 

			//
			// Display igroup_id as real name
			//
			$sql = "SELECT c.center_abbr, i.igroup_name from center c, igroup i";
			$sql .= " WHERE i.igroup_cen = c.center_id AND i.igroup_id = '$igid'";
			echo "<p class=trace>$sql</P>\n"; // DEVONLY
			$iresult = mysql_query($sql);
			$Igroup = array();
			$Igroup = mysql_fetch_array($iresult, MYSQL_ASSOC) ; 

			//
			// Get warrior_ighistory fieldnames and labels
			//
			$fieldlabel = array();
			$fields = array();
			$fieldlabel = get_field_labels('warrior_ighistory','ighistory');
			unset ($fieldlabel['ighistory_id']);
			$fields = array_keys($fieldlabel);
			$Val = array();

			//
			// Populate values of form to display
			//
			foreach ($fieldlabel as $field => $label) {
				if (isset ($_REQUEST[$field] ) ) {
					$Val[$field] = $_REQUEST[$field];
				}
			}

			$today = date('Y-m-d');
			$who = $Warrior['war_fname'] . ' ' . $Warrior['war_lname'];
			$igroup = $Igroup['center_abbr'] . ': ' . $Igroup['igroup_name'];

			$msql = "SELECT choice from menu where table_name = 'warrior_ighistory'";
			$msql .= " AND field_name = 'exit_reason'";
			echo "<p class=trace>$msql</P>\n"; // DEVONLY
			$Reason = array();
			$Reason = get_menu($msql);

			echo "<CENTER>\n";
			echo "<H2>Removing $who from I-Group $igroup</H2>\n";
			echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
			echo "<TABLE BORDER>\n";

			echo "<TR>\n";
			echo "<TD class=tdls>Exit Reason</TD>\n";
			echo "<TD class=tds>\n";
				spew_select_menu('exit_reason','Choose','Choose',$Reason);
			echo "</TD>\n";

			echo "<TR>\n";
			echo "<TD class=tdls>Exit Date<BR>(YYYY-MM-DD)</TD>\n";
			echo "<TD class=tds>\n";
				echo "<INPUT TYPE=TEXT NAME=end_date VALUE=\"$today\">\n";
			echo "</TD>\n";

			echo "<TR>\n";
			echo "<TD class=tdls VALIGN=TOP>Exit Comments<BR>(Optional)</TD>\n";
			echo "<TD class=tds>\n";
				echo "<TEXTAREA NAME=exit_comment COLS=50 ROWS=20></TEXTAREA>\n";
			echo "</TD>\n";

			echo "</TABLE>\n";
			echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$igid>\n";
			echo "<INPUT TYPE=HIDDEN NAME=warrior_id VALUE=$wid>\n";
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"Remove Initiated Member\">\n";
			echo "</FORM>\n";
			echo "</CENTER>\n";

			$_REQUEST['Action'] = "Manage My I-Group";
		}

		//----------------------------------------------------------------------
		// Process Exit of Uniniated Man from I-Group
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Visitor Exit" ) {
			echo "<P class=trace>Entering Prospect Exit for Non-Warrior</P>\n"; // DEVONLY

			caa_connect();

			$vid = $_REQUEST['igvisitor_id'];
			$igid = $_REQUEST['igroup_id'];

			//
			// Display igvisitor_id as real name
			//
			$sql = "SELECT igvisitor_fname, igvisitor_lname from igvisitor where igvisitor_id = '$vid'";
			echo "<p class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
			$Visitor = array();
			$Visitor = mysql_fetch_array($result, MYSQL_ASSOC) ; 

			//
			// Display igroup_id as real name
			//
			$sql = "SELECT c.center_abbr, i.igroup_name from center c, igroup i";
			$sql .= " WHERE i.igroup_cen = c.center_id AND i.igroup_id = '$igid'";
			echo "<p class=trace>$sql</P>\n"; // DEVONLY
			$iresult = mysql_query($sql);
			$Igroup = array();
			$Igroup = mysql_fetch_array($iresult, MYSQL_ASSOC) ; 

			//
			// Get igvisitor_ighistory fieldnames and labels
			//
			$fieldlabel = array();
			$fields = array();
			$fieldlabel = get_field_labels('ighistory_ighistory','ighistory');
			unset ($fieldlabel['ighistory_id']);
			$fields = array_keys($fieldlabel);
			$Val = array();

			//
			// Populate values of form to display
			//
			foreach ($fieldlabel as $field => $label) {
				if (isset ($_REQUEST[$field] ) ) {
					$Val[$field] = $_REQUEST[$field];
				}
			}

			$today = date('Y-m-d');
			$who = $Visitor['igvisitor_fname'] . ' ' . $Visitor['igvisitor_lname'];
			$igroup = $Igroup['center_abbr'] . ': ' . $Igroup['igroup_name'];

			$msql = "SELECT choice from menu where table_name = 'igvisitor_ighistory'";
			$msql .= " AND field_name = 'exit_reason'";
			echo "<p class=trace>$msql</P>\n"; // DEVONLY
			$Reason = array();
			$Reason = get_menu($msql);

			echo "<CENTER>\n";
			echo "<H2>Removing Non-Warrior $who from I-Group $igroup</H2>\n";
			echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
			echo "<TABLE BORDER>\n";

			echo "<TR>\n";
			echo "<TD class=tdls>Exit Reason</TD>\n";
			echo "<TD class=tds>\n";
				spew_select_menu('exit_reason','Choose','Choose',$Reason);
			echo "</TD>\n";

			echo "<TR>\n";
			echo "<TD class=tdls>Exit Date<BR>(YYYY-MM-DD)</TD>\n";
			echo "<TD class=tds>\n";
				echo "<INPUT TYPE=TEXT NAME=end_date VALUE=\"$today\">\n";
			echo "</TD>\n";

			echo "<TR>\n";
			echo "<TD class=tdls VALIGN=TOP>Exit Comments</TD>\n";
			echo "<TD class=tds>\n";
				echo "<TEXTAREA NAME=exit_comment COLS=50 ROWS=20></TEXTAREA>\n";
			echo "</TD>\n";

			echo "</TABLE>\n";
			echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$igid>\n";
			echo "<INPUT TYPE=HIDDEN NAME=igvisitor_id VALUE=$vid>\n";
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"Remove Uninitiated Member\">\n";
			echo "</FORM>\n";
			echo "</CENTER>\n";

			$_REQUEST['Action'] = "Manage My I-Group";
			unset ($_REQUEST['igroup_id']);
		}

		//----------------------------------------------------------------------
		// Remove Initiated member from my I-Group
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Remove Initiated Member" ) {
			echo "<PRE>\n";		 // DEVONLY
			print_r($_REQUEST);	 // DEVONLY
			echo "</PRE>\n";		// DEVONLY

			caa_connect();

			$Required = array (
				'igroup_id'			=>	'I-Group ID',
				'warrior_id'		=>	'warrior ID',
				'exit_reason'		=>	'reason man exited I-Group'
			);

			if ( $_REQUEST['exit_reason'] == "Choose" ){
				unset ( $_REQUEST['exit_reason']);
			}

			//
			// Data Integrity Gauntlet
			//
			foreach ($Required as $f => $reason) {
				if (! isset ( $_REQUEST[$f] )) {
					$err .= '<LI>Please enter or include ' . $Required[$f] . '</LI>';
				}
			}
			if ( isset ($err)) {
				echo "<CENTER>";
				echo "<TABLE>";
				echo "<TH>Error</TH>\n";
				echo "<TR><TD><UL>$err</UL></TD>";
				echo "</TABLE>";
				spew_footer($FMT);
				exit;
			}
			$today = date('Y-m-d');

			//
			// See if there is a warrior_ighistory entry for this man
			//
			$wid = $_REQUEST['warrior_id'];
			$igid = $_REQUEST['igroup_id'];

			if ($_REQUEST['exit_reason'] == "Never a member") {
				$sql = "DELETE from warrior_ighistory WHERE ";
				$sql .= " igroup_id = '$igid' AND warrior_id = '$wid'";
			}else{
				$sql = "SELECT * from warrior_ighistory WHERE ";
				$sql .= " igroup_id = '$igid' AND warrior_id = '$wid'";
				$sql .= " ORDER BY ighistory_id desc limit 1";

				echo "<p class=trace>$sql</P>\n"; // DEVONLY

				$result = mysql_query($sql);
				$num = mysql_num_rows($result);

				$val = mysql_real_escape_string($_REQUEST['exit_comment']);

				if ( $num > 0 ) {

					$History = array();
					$History = mysql_fetch_array($result, MYSQL_ASSOC) ; 
					$hid = $History['ighistory_id'];
	
					$sql = "UPDATE warrior_history set" ;
					$sql .= " end_date = '$today' ";
					$sql .= " AND exit_reason = '$_REQUEST[exit_reason]'";
					$sql .= " AND exit_comment =  '$val'";
					$sql .= " WHERE ighistory_id = '$hid'";

					echo "<p class=trace>$sql</P>\n"; // DEVONLY

				}else{

					$sql = "INSERT INTO warrior_history ";
					$sql .= "(warrior_id, igroup_id, end_date, exit_reason, exit_comment)";
					$sql .= "VALUES ('$wid','$igid','$today','$_REQUEST[exit_reason]','$val')";

					echo "<p class=trace>$sql</P>\n"; // DEVONLY
				}
			}

			mysql_query($sql); 	// SAFETY
			//
			// Delete from warrior_igroup, no longer current member
			//
			$sql = "DELETE FROM warrior_igroup WHERE war_ig_ig = '$igid' AND war_ig_war = '$wid'";
			echo "<p class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql); // SAFETY

			//
			// If I am removing me, update or delete my session igroups list
			//

			if ( $_REQUEST['warrior_id'] == $_SESSION['war_id'] ) {
				if (array_key_exists('igroups', $_SESSION)){
					echo "<P class=trace>BEFORE: $_SESSION[igroups]</P>\n"; // DEVONLY
					$igs = array();
					$igs = explode('|', $_SESSION[igroups]);
					foreach ($igs as $key => $val){
						if ($val == $igid) {
							unset ($igs[$key]);
						}
					}
					if ( count($igs) > 1 )  {
						$_SESSION[igroups] = implode('|', $igs);
						$igs = explode('|', $_SESSION[igroups]);
						echo "<P class=trace>AFTER: $_SESSION[igroups]</P>\n"; // DEVONLY
					}else{
						unset ($_SESSION['igroups']);
						echo "<P class=trace>AFTER... Should be NULL: $_SESSION[igroups]</P>\n"; // DEVONLY
					}
				}
				if ($_SESSION['igroup_id'] == $_REQUEST['igroup_id'] ) {
					unset ($_SESSION['igroup']);
				}

			}

			unset ($_REQUEST['igroup_id']);
			$_REQUEST['Action'] = "Manage My I-Group";
		}

		//----------------------------------------------------------------------
		// Remove Uniniated member from my I-Group
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Remove Uninitiated Member" ) {

			caa_connect();

			$Required = array (
				'igroup_id'			=>	'I-Group ID',
				'igvisitor_id'		=>	'Visitor ID',
				'exit_reason'		=>	'reason man exited I-Group'
			);

			if ( $_REQUEST['exit_reason'] == "Choose" ){
				unset ( $_REQUEST['exit_reason']);
			}

			//
			// Data Integrity Gauntlet
			//
			foreach ($Required as $f => $reason) {
				if (! isset ( $_REQUEST[$f] )) {
					$err .= '<LI>Please enter or include ' . $Required[$f] . '</LI>';
				}
			}
			if ( isset ($err)) {
				echo "<CENTER>";
				echo "<TABLE>";
				echo "<TH>Error</TH>\n";
				echo "<TR><TD><UL>$err</UL></TD>";
				echo "</TABLE>";
				spew_footer($FMT);
				exit;
			}
			$today = date('Y-m-d');

			//
			// See if there is an igvisitor_ighistory entry for this man
			//
			$vid = $_REQUEST['igvisitor_id'];
			$igid = $_REQUEST['igroup_id'];
			if ($_REQUEST['exit_reason'] == "Never a member") {
				$sql = "DELETE from igvisitor_ighistory WHERE ";
				$sql .= " igroup_id = '$igid' AND igvisitor_id = '$vid'";
			}else{

				$sql = "SELECT * FROM igvisitor_ighistory WHERE ";
				$sql .= " igroup_id = '$igid' AND igvisitor_id = '$vid'";
				echo "<p class=trace>$sql</P>\n"; // DEVONLY
				$result = mysql_query($sql);
				$num = mysql_num_rows($result);
				if ( $num > 0 ) {
					if ( $num > 1 ) {
						echo "<H1>ERROR: Multiple igvisitor_ighistory records";
						echo " for igvisitor_id of $vid and igroup_id of $igid";
						echo "</H1>\n";
						echo "<H2>Contact Administrator</H2>\n";
						spew_footer($FMT);
						exit;
					}
					$History = array();
					$History = mysql_fetch_array($result, MYSQL_ASSOC) ; 
					$hid = $History['ighistory_id'];
	
					$sql = "UPDATE igvisitor_history set" ;
					$sql .= " end_date = '$today' ";
					$sql .= " AND exit_reason = '$_REQUEST[exit_reason]'";
					$sql .= " AND exit_comment =  '$_REQUEST[exit_comment]'";
					$sql .= " WHERE ighistory_id = '$hid'";
					echo "<p class=trace>$sql</P>\n"; // DEVONLY
				}else{
					$sql = "INSERT INTO igvisitor_history ";
					$sql .= "(igvisitor_id, igroup_id, end_date, exit_reason, exit_comment)";
					$sql .= "VALUES ('$vid','$igid','$today','$_REQUEST[exit_reason]','$_REQUEST[exit_comment]')";
					echo "<p class=trace>$sql</P>\n"; // DEVONLY
				}
			}

			mysql_query($sql); 	// SAFETY
			//
			// Update igvisitor_igroup
			//
			$sql = "DELETE FROM igvisitor_igroup WHERE igroup_id = '$igid' AND igvisitor_id = '$vid'";
			echo "<p class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql); // SAFETY

			unset ($_REQUEST['igroup_id']);
			$_REQUEST['Action'] = "Manage My I-Group";
		}

		//----------------------------------------------------------------------
		// Update Start Date
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Update Start Dates" ) {
			caa_connect();

			//mysql> desc warrior_ighistory;
			//+--------------+------------------+------+-----+---------+----------------+
			//| Field		| Type			 | Null | Key | Default | Extra		  |
			//+--------------+------------------+------+-----+---------+----------------+
			//| ighistory_id | int(10) unsigned | NO   | PRI | NULL	| auto_increment |
			//| warrior_id   | int(10) unsigned | NO   |	 | NULL	|				|
			//| igroup_id	| int(10) unsigned | NO   |	 | NULL	|				|
			//| start_date   | date			 | YES  |	 | NULL	|				|
			//| end_date	 | date			 | YES  |	 | NULL	|				|
			//| exit_reason  | varchar(30)	  | YES  |	 | NULL	|				|
			//| exit_comment | text			 | YES  |	 | NULL	|				|
			//+--------------+------------------+------+-----+---------+----------------+

			//start_date_warrior_${igid}_${wid}
			//start_date_visitor_${igid}_${vid}
			foreach ($_REQUEST as $key => $val ) {
				if ( preg_match('/^start_date_/', $key) ) {
					list ($x1,$x2,$type,$igid,$whoid) = explode('_',$key);

					if (empty ($val) ) {
						continue;
					}else{
						$sd = $val;
						$err = validate_date($sd);
						if (! empty ($err)) {
							echo "<CENTER>\n";
							echo "<TABLE>\n";
							echo "<TR><TD>$sd : $err</TD>\n";
							echo "</TABLE>\n";
							echo "</CENTER>\n";
							continue;
						}
					}

					if ($type == 'warrior') {
						$wid = $whoid;
						echo "<P class=trace>Type is Warrior: $wid</P>\n";	// DEVONLY

						//===========================================================
						// Warrior Update
						//===========================================================
						if ( ! empty ($wid) ) {
			
							//
							// See if warrior_ighistory exists
							//
							$sql = "SELECT * from warrior_ighistory WHERE warrior_id = '$wid' AND igroup_id = '$igid'";
							$sql .= " ORDER BY ighistory_id desc limit 1";
							$result = mysql_query($sql);
							$num = mysql_num_rows($result);
							echo "<P class=trace>Warrior Update: [$sql] : Returns $num results</P>\n"; // DEVONLY
				
							//
							// Create new entry if not
							//
							if (  $num < 1 ) {
								$sql = "INSERT INTO warrior_ighistory (warrior_id, igroup_id, start_date)";
								$sql .= " VALUES ('$wid','$igid','$sd')";
								echo "<p class=trace>$sql</P>\n"; // DEVONLY
								mysql_query($sql);
							}else{ // Update if exists
								$History = array();
								$History = mysql_fetch_array($result, MYSQL_ASSOC) ;
				
								echo "<PRE>\n"; //DEVONLY
								echo "<B>Existing History Entry</B>\n"; // DEVONLY
								//print_r($History); // DEVONLY
								echo "</PRE>\n"; //DEVONLY
				
								$hid = $History['ighistory_id'];
								$sql = "UPDATE warrior_ighistory set start_date = '$sd' WHERE ighistory_id = '$hid'";
								echo "<p class=trace>$sql</P>\n"; // DEVONLY
								mysql_query($sql);
							}
						}// Endif ! empty ($wid)
			
					}// Endif type = 'warrior'
					if ($type == 'visitor') {
						$vid = $whoid;
						echo "<P class=trace>Type is Visitor: $vid</P>\n";	// DEVONLY
			
						//===========================================================
						// Visitor Update
						//===========================================================
						if ( ! empty ($vid) ) {
			
							//
							// See if igvisitor_ighistory exists
							//
							$sql = "SELECT * from igvisitor_ighistory ";
							$sql .= " WHERE igvisitor_id = '$vid' AND igroup_id = '$igid'";
							$sql .= " ORDER BY ighistory_id desc limit 1";
							$result = mysql_query($sql);
							$num = mysql_num_rows($result);
							echo "<P class=trace>$sql : Returns $num results</P>\n"; // DEVONLY
				
							//
							// Create new entry if not
							//
							if ( $num < 1 ) {
								$sql = "INSERT INTO igvisitor_ighistory (igvisitor_id, igroup_id, start_date)";
								$sql .= " VALUES ('$vid','$igid','$sd')";
								echo "<p class=trace>$sql</P>\n"; // DEVONLY
								mysql_query($sql);
							}else{ // Update if exists
								$VisitorHistory = array();
								$VisitorHistory = mysql_fetch_array($result, MYSQL_ASSOC) ;
				
								echo "<PRE>\n"; //DEVONLY
								echo "<B>Existing History Entry</B>\n"; // DEVONLY
								//print_r($VisitorHistory); // DEVONLY
								echo "</PRE>\n"; //DEVONLY
				
								$hid = $VisitorHistory['ighistory_id'];
								$sql = "UPDATE igvisitor_ighistory ";
								$sql .= " SET start_date = '$sd' ";
								$sql .= " WHERE ighistory_id = '$hid'";
								echo "<p class=trace>$sql</P>\n"; // DEVONLY
								mysql_query($sql);
							}
						}// Endif empty ($vid)
					}// Endif Visitor
				}// Endif preg_match
			}//Endforeach $_REQUEST

			// Workflow change
			$_REQUEST['Action'] = "Manage My I-Group";
		}


		//----------------------------------------------------------------------
	  	// Insert New Entry
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Insert New Entry" ) {
			$caadbh = caa_connect();
			// Get list of fields for this table
			$fieldlabel = get_field_labels('igroup','igroup');
			$fields = array_keys($fieldlabel);
			sort($fields);

			// Eliminate all keys that have invalid answers
			foreach ($fields as $f) {
				if (in_array($_REQUEST[$f], $InValidChoice)) {
					unset ($_REQUEST[$f]);
				}
			}

			// Delete auto_increment primary keys
			unset ($_REQUEST['igroup_id']);

			// Requred fields gauntlet
			foreach ($RequiredField as $key => $val) {
				if (! array_key_exists($key, $_REQUEST)) {
					$err .= '<LI>Please ' . $RequiredField[$key] . '.</LI>';
				}
			}
			if ( $err ) {
				echo "<CENTER>\n";
				echo "<H3>Incomplete Information</H3>\n";
				echo "<TABLE id=error_form_incomplete BORDER>\n";
				echo "<TR><TD><UL>$err</UL></TD></TABLE>\n";
				echo "</TABLE>\n";
				echo "</CENTER>\n";
				spew_footer($FMT);
				exit;
			}

			$sql = 'INSERT INTO igroup (';
			foreach ($fields as $f) {
				$sql .= $f . ',';
			}
			foreach ($fields as $f) {
				$val = mysql_real_escape_string($_REQUEST[$f]);
				$sql2 .= "'" . $val . "'" . ',';
			}
			echo "<CENTER>\n";

			//
			// Add this I-Group
			//

			$finalsql = rtrim($sql, ",") .  ') VALUES (' .  rtrim($sql2, ",") . ")";
			echo "<p class=trace>$finalsql</p>\n";	//DEBUG
			$result = mysql_query($finalsql) or die('Error, query failed: $sql' . mysql_error() );
			$igid = mysql_insert_id();
			echo "<H2>I-Group successfully added ($igid)</H2>\n";



			//mysql> desc warrior_ighistory;
			//+--------------+------------------+------+-----+---------+----------------+
			//| Field		| Type			 | Null | Key | Default | Extra		  |
			//+--------------+------------------+------+-----+---------+----------------+
			//| ighistory_id | int(10) unsigned | NO   | PRI | NULL	| auto_increment |
			//| warrior_id   | int(10) unsigned | NO   |	 | NULL	|				|
			//| igroup_id	| int(10) unsigned | NO   |	 | NULL	|				|
			//| start_date   | date			 | YES  |	 | NULL	|				|
			//| end_date	 | date			 | YES  |	 | NULL	|				|
			//| exit_reason  | varchar(30)	  | YES  |	 | NULL	|				|
			//| exit_comment | text			 | YES  |	 | NULL	|				|
			//+--------------+------------------+------+-----+---------+----------------+

			$today = date('Y-m-d');
			$sql = "INSERT INTO warrior_ighistory (warrior_id, igroup_id, start_date) ";
			$sql .= " VALUES ('$wid','$igid','$today')";
			echo "<p class=trace>$finalsql</p>\n";	//DEBUG
			mysql_query($sql);
			$ighid = mysql_insert_id();
			echo "<H2>I-Group History successfully added ($ighid)</H2>\n"; // DEVONLY

			//
			// If New Location selected, create stub location
			//
			if ($_REQUEST['location_id'] < 4 ) {

				$locname  = $_REQUEST['igroup_name'] . ' I-Group';
				$locname = preg_replace('/\'/', '\'\'', $locname);
				$loc_id = ($igid + 5000);
				$sql = "INSERT INTO fulllocation (location_id, location_name, location_type)";
				$sql .= " VALUES ('$loc_id','$locname','Small Group')";
				echo "<P class=trace>$sql</P>\n"; // DEVONLY
				mysql_query($sql);
				$sql = "UPDATE igroup set location_id = '$loc_id' where igroup_id = '$igid'";
				echo "<P class=trace>$sql</P>\n"; // DEVONLY
				mysql_query($sql);
				echo "<H2>Created location record ($loc_id)</H2>\n";
				$_REQUEST['location_id'] = $loc_id;

			}

			//
			// Add This Man to the I-Group
			//
			$wid = $_SESSION['war_id'];
			$sql = "INSERT INTO warrior_igroup ( war_ig_war, war_ig_ig) VALUES ( '$wid','$igid')";
			$sql .= " ON DUPLICATE KEY UPDATE  war_ig_war = '$wid'";
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			mysql_query($sql) ;
			$wigid = mysql_insert_id();
			echo "<H2>Successfully added you as member of this I-Group ($wigid)</H2>\n";
			//
			// Update his session
			//
			if ( isset ( $_SESSION['igroup_id'] ) ){
				if ( isset ( $_SESSION['igroups'] ) ){
					$_SESSION['igroups'] .= '|' . $igid;
				}else{
					$_SESSION['igroups'] .= $_SESSION['igroup_id'] . '|' . $igid;
				}
			}else{
				$_SESSION['igroup_id'] = $igid;
			}

			echo "</CENTER>\n";

			$_REQUEST['Action'] = "Manage My I-Group";
		}

		//----------------------------------------------------------------------
	  	// Update Existing Entry
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Update" ) {
			if (! array_key_exists('igroup_id', $_REQUEST)) {
				die ("No I-Group ID Set for Update Function") ;
			}
			$caadbh = caa_connect();

			// Get list of fields for this table
			$fieldlabel = get_field_labels('igroup','igroup');
			$fields = array_keys($fieldlabel);

			// Eliminate all keys that have invalid answers
			foreach ($fields as $f) {
				if (in_array($_REQUEST[$f], $InValidChoice)) {
					unset ($_REQUEST[$f]);
				}
			}

			$goodfields = array();
			// Find the extended entries for picklists and return 
			// them to base names, overwriting picklist entry
			foreach ($fields as $f) {
				$altkey = "NEW_" . $f;
				if (array_key_exists($altkey, $_REQUEST)) {
					$goodfields[$f] = $_REQUEST[$altkey];
					$_REQUEST[$f] =  $_REQUEST[$altkey];
					unset ($_REQUEST[$altkey]);
				}else{
					if ($_REQUEST[$f]) {
						$goodfields[$f] = $_REQUEST[$f];
					}
				}
			}

			$fields = array_keys($goodfields);
			sort($fields);

			// Requred fields gauntlet
			foreach ($RequiredField as $key => $val) {
				if (! array_key_exists($key, $goodfields)) {
					$err .= '<LI>Please ' . $RequiredField[$key] . '.</LI>';
				}
			}
			if ( $err ) {
				echo "<CENTER>\n";
				echo "<H3>Incomplete Information</H3>\n";
				echo "<TABLE id=error_form_incomplete BORDER>\n";
				echo "<TR><TD><UL>$err</UL></TD></TABLE>\n";
				echo "</TABLE>\n";
				echo "</CENTER>\n";
				spew_footer($FMT);
				exit;
			}

			$sql = 'UPDATE igroup SET ';
			$sqlentry = array ();
			foreach ($fields as $f) {
				$val = mysql_real_escape_string($_REQUEST[$f]);
				$val = preg_replace("/\\\'/", "''", $val);	// O\'Neil -> O''Neil
				$sqlentry[] =   $f . " = '" . $val . "'";
			}
			$sql .= implode (', ', $sqlentry);
			$sql .= " WHERE igroup_id = '$goodfields[igroup_id]'";

			echo "<p class=trace>$sql</p>\n";	//DEBUG

			$result = mysql_query($sql) or die('Error, query failed: $sql' . mysql_error() );
			echo "<CENTER><H3>Update successful</H3></CENTER>\n";
			if (isset ($_REQUEST['ThenWhat'] ) ) {
				$_REQUEST['Action'] = $_REQUEST['ThenWhat'];
			}else{
				$_REQUEST['Action'] = 'Manage My I-Group';
			}
		}

		//----------------------------------------------------------------------
	  	// Query 
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "Query" 
			|| $_REQUEST['Action'] == "List" 
			|| $_REQUEST['Action'] == "List My Center I-Groups" 
			|| $_REQUEST['Action'] == "My Center" 
			|| $_REQUEST['Action'] == "Query Reps" 
			|| $_REQUEST['Action'] == "List Reps" 
			|| $_REQUEST['Action'] == "Manage My I-Group" ) {

			caa_connect();
			$parameters = array();
			$validentries = array();

			$From =  array(
				'igroup'			=>	'i',
				'warrior_igroup'	=>	'x',
				'fulllocation'		=>	'f'
				);

			// Field Labels from igroup table
			$fieldlabel = get_field_labels('igroup','igroup');
			$fields = array_keys($fieldlabel);

			// TODO: Update messages
			$fieldlabel[igroup_cen] = "Center";
			$fieldlabel[igroup_newmembers] = "New Members";
			$fieldlabel[igroup_reg] = "I-Group Region";

			// Field Labels from fulllocation table
			$locfieldlabel = get_field_labels('fulllocation','location');
			$locfields = array_keys($locfieldlabel);

			// Combined I-Group and fulllocation Field Labels
			$allfieldlabel = array_merge($fieldlabel, $locfieldlabel);
			$allfieldlabel['location_name'] = 'Location';
			$allfieldlabel['igroup_name'] = 'I-Group Name';
			$allfieldlabel['location_id'] = 'Location Name';

			$CloakMe = array();	
			if ($_REQUEST['Action'] == "Query Reps" 
				|| $_REQUEST['Action'] == "List Reps" 
				) {
				$allfieldlabel['war_cphone'] = 'Cell Phone';
				$allfieldlabel['war_hphone'] = 'Home Phone';
				$SHOW = $SHOWREPS;
				$ALLFIELD[] = 'war_hphone';
				$ALLFIELD[] = 'war_cphone';
				//
				// Identify warriors who do not want their contact information shown
				//
				$cloaksql = "SELECT DISTINCT p.warrior_id FROM warrior_preference p, igroup i";
				$cloaksql .= " WHERE p.preference_id = '97' and p.preference_value = 'No'";
				$cloaksql .= " AND i.igroup_rep = p.warrior_id ";
				echo "<P class=trace>$cloaksql</P>\n";	// DEVONLY
				$CloakMe = get_menu($cloaksql);
				print_r($CloakMe);	// DEVONLY

			}

			$validentries = array();

			foreach(explode( '&', $_SERVER[QUERY_STRING])  as $entry ) {
				list($param, $val) = explode( '=', $entry);	
				if ( $val ) {
					if (! in_array($val, $InValidChoice)) {
						if (in_array($param, $ALLFIELD) ) {
							$parameters[$param] = $val;
						}
					}
				}
			}

			foreach ($parameters as $key => $val ) {
				$validentries[] = $key . '=' . $val;
			}

			$drilldown = implode('&', $validentries);

			// Spaces bad
			$drilldown = preg_replace('/\s+/', '+', $drilldown);
			echo "<P class=trace>Drilldown: $drilldown</P>\n"; // DEVONLY

			//
			// Special Lookup for Center name to id match
			//
			$Center = array();
			$csql = "SELECT DISTINCT center_id, short_name FROM center";
			$Center = get_menu_array($csql);

			//
			// Special Lookup for Region name to id match
			//
			$Region = array();
			$rsql = "SELECT DISTINCT igrpreg_id, igrpreg_name from igroup_regions";
			$Region = get_menu_array($rsql);

			//echo "<PRE>\n";	//DEBUG DEVONLY
			//print_r($Region); // DEBUG DEVONLY
			//echo "</PRE>\n";	//DEBUG DEVONLY

			$sql = "SELECT ";
			$What = array (
			'i.igroup_id', 'i.igroup_name', 'i.igroup_status', 'i.igroup_cen',
			'i.igroup_reg', 'i.igroup_frequency', 'i.igroup_night', 'i.igroup_mixed', 'i.igroup_newmembers',
			'i.igroup_rep', 'i.igroup_time', 'i.igroup_visit_initiated', 'i.igroup_visit_uninitiated',
			'f.location_id', 'f.center_id', 'f.location_state', 'f.location_city', 'f.location_country',
			'f.location_latitude', 'f.location_longitude',
			'count(x.war_ig_war) as count',
			'f.location_name', 'f.location_street'
			);

			$Where = array(
				'f.location_id = i.location_id',
				'i.igroup_id = x.war_ig_ig',
				"i.igroup_name NOT LIKE 'None:%'"	// Skip non I-Groups
				);

			if ($_REQUEST['Action'] == "Query Reps" ) {
				$What[] = 'w.war_fname';
				$What[] = 'w.war_lname';
				$What[] = 'w.war_hphone';
				$What[] = 'w.war_cphone';
				$What[] = 'w.war_email';
				$Where[] = 'i.igroup_rep = w.war_id';
				$From['warrior'] = 'w';
			}
			$userwhere = array();

			//
			// Special case for My Center
			//
			if ( $_REQUEST['Action'] == "My Center" ) {
				if ( ! empty( $_SESSION['center_id']) ) {
					$Where[] = "i.igroup_cen = '" . $_SESSION['center_id'] . "'";
					$_REQUEST['Sortmeby'] = 'Name';
					unset ($_REQUEST['igroup_cen']);
				}
			}
				
			//
			// Special case for Manage My I-Groups
			//
			if ($_REQUEST['Action'] == "Manage My I-Group" ) {
				// Multiple I-Groups?
				if ( isset ($_SESSION['igroups']) ) {
					$iglist = array();
					$igors = array();

					$iglist = explode('|', $_SESSION['igroups']);
					foreach ($iglist as $ig) {
						$igors[] = "i.igroup_id = '" . $ig . "'";
					}
					$Where[] = '(' . implode( ' OR ', $igors) . ')';
				}else{
					$Where[] = "i.igroup_id = $_SESSION[igroup_id]";
				}
			}
			//
			// Go through I-Group Fields
			//
			foreach ($fields as $f) {
				if (array_key_exists($f, $_REQUEST)) { 
					$val = $_REQUEST[$f];
					print "<P class=trace>Val for $f is $val</P>\n";	// DEVONLY

					if (in_array($val, $InValidChoice)){
						unset($val) ;
					}
                    //
                    // Partial Match for Name
                    //
                    if ( $f == 'igroup_name' ) {
                        $_REQUEST[$f] = '%' . $_REQUEST[$f] . '%';
                    }

					if ($val) {
						$From['igroup'] = 'i';


						// Database readable
						$cleanval = mysql_real_escape_string($_REQUEST[$f]);
						if ( preg_match('/\%/', $cleanval) ) {
							$Where[] = 'i.' . $f . " LIKE '" . $cleanval . "'" ;
							$usqlw = $allfieldlabel[$f] . " like '" . $val . "'" ;
						}else{
							$Where[] = 'i.' . $f . " ='" . $cleanval . "'" ;
							$usqlw = $allfieldlabel[$f] . " = '" . $val . "'" ;
						}

						// Override for center and region id -> name maps
						if ( $f == "igroup_cen" ) {
							print "<P class=trace>For igroup_cen Val for $f is $val, Center map is $Center[$val]</P>\n";	// DEVONLY
							$usqlw = $allfieldlabel[$f] . " = '" . $Center[$val] . "'" ;
						}
						if ( $f == "igroup_reg" ) {
							print "<P class=trace>For igroup_reg Val for $f is $val, Region map is $Region[$val]</P>\n";	// DEVONLY
							$usqlw = $allfieldlabel[$f] . " = '" . $Region[$val] . "'" ;
						}

						// User readable
						$userwhere[] = $usqlw;
					}
				}
			}

			//
			// Go through Fulllocation Fields
			//
			foreach ($locfields as $f) {
				if (array_key_exists($f, $_REQUEST)) { 
					$From['fulllocation'] = 'f';
					$val = $_REQUEST[$f];

					if (in_array($val, $InValidChoice)){
						unset($val) ;
					}

					if ($val) {
						$From['fulllocation'] = 'f';
						// User readable
						$usqlw = $locfieldlabel[$f] . " = '" . $val . "'" ;
						$userwhere[] = $usqlw;

						// Database readable
						$cleanval = mysql_real_escape_string($_REQUEST[$f]);
						$Where[] = 'f.' . $f . "='" . $cleanval . "'" ;
					}
				}
			}

			$fromsql = array();
			foreach ($From as $table => $abbreviation) {
				$fromsql[] = $table . ' AS ' . $abbreviation;
			}
			$sql = "SELECT ";
			$sql .=  implode(',', $What);
			$sql .= " FROM " . implode(', ', $fromsql);

			if ( count($Where) ) {
				$sql .= ' WHERE ' . implode(' AND ', $Where);
			}
			//
			// Hardwire group by for count men in warrior_igroup
			//
			$sql .= " GROUP BY x.war_ig_ig ";
			//
			// Sort/Order by
			//
			$SortBy = array (
				'City'				=>	'f.location_city, f.location_name',
				'State'				=>	'f.location_state, f.location_city',
				'Country'			=>	'f.location_country,f.location_state',
				'I-Group Region'	=>	'i.igroup_reg,f.location_city',
				'State'				=>	'f.location_state,f.location_city',
				'Name'				=>	'i.igroup_name',
				'Location'			=>	'f.location_name,i.igroup_name',
				'Zip'				=>	'f.location_zip,f.location_city'
				);

			$sby = $_REQUEST['Sortmeby'];
			if ( empty($sby) ){
				$sql .= " ORDER BY f.location_city ";
			}else{
				$sql .= " ORDER BY " . $SortBy[$sby];
			}

			//
			// Version for User to see
			//
			if ( count($userwhere) ) {
				array_unique($userwhere);
				sort($userwhere);
				$usersql .= 'List I-Groups where ' . implode(' AND ', $userwhere);
			}

			echo "<P class=trace>$sql</P>\n"; // DEVONLY

			$result = mysql_query($sql);
			$num = mysql_num_rows($result);

	
			$result = mysql_query($sql) or die('Error, query failed: $sql' . mysql_error() );

			// Start Blurb
			echo "<P class=trace>Click on <I>I-Group Name</I> link to view roster, <I>Location Name</I> link to see location details. ";

			echo "<BR>\n";
	  		if ($_REQUEST['Action'] == "Manage My I-Group" ) {
				echo " Click on green icon to edit I-Group info.";
			}
			echo " Purple icon shows Google Map. Other link ";
			echo "entries &quot;drill down&quot; to narrow your query.\n";
			echo "<BR>";
			if ( $num > 1 ) {
				if ( ! empty ($usersql) ) {
					echo "$usersql, ";
				}
				echo " $num entries.\n";
			}else{
				if ( ! empty ($usersql) ) {
					echo "$usersql, ";
				}
				echo " $num entry.\n";
			}
			echo "</P>\n";
			// End Blurb

			echo "<CENTER>\n";
			echo "<TABLE id=igroups_query_results BORDER>\n";
			if ($_REQUEST['Action'] == "Manage My I-Group" ) {
				echo "<TH class=ths>Edit</TH>\n";
			}

			echo "<TH class=ths>View</TH>\n";
			echo "<TH class=ths>Map</TH>\n";
			echo "<TH class=ths>Size</TH>\n";
			unset($fields[igroup_id]);

			foreach ($ALLFIELD as $f) {
				if (in_array($f, $SHOW)) {
					echo "<TH class=ths>$allfieldlabel[$f]</TH>\n";
				}
			}
			while ($row = mysql_fetch_array($result, MYSQL_ASSOC) ) {
				echo "<TR>\n";
				// Edit
				if ($_REQUEST['Action'] == "Manage My I-Group" ) {
					echo "<TD ALIGN=CENTER VALIGN=TOP class=tdcs>";
						echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$row[igroup_id]";
						echo "&Action=Edit>";
						echo "<IMG SRC=/images/smallballs/greenball.gif BORDER=0></A>";
					echo "</TD>\n";
				}

				// View
				echo "<TD ALIGN=CENTER VALIGN=TOP class=tdcs>";

					if (array_key_exists('access', $_SESSION)) {
						if ( $_SESSION['access'] >= $IGCFG['EDITLEVEL'] 
							|| $_SESSION['igroup_id'] == $row['igroup_id']
						) {
							//echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$row[igroup_id]";
							//echo "&Action=Edit>";
							//echo "<IMG SRC=/images/smallballs/greenball.gif BORDER=0></A>";
						}
					}
		
					echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$row[igroup_id]";
					echo "&Action=View>";
					echo "<IMG SRC=/images/smallballs/yellowball.gif BORDER=0></A>";
				echo "</TD>\n";

				// MAP
				echo "<TD ALIGN=CENTER VALIGN=TOP class=tdcs>";
				$geo = abs($row['location_latitude']) + abs($row['location_longitude']);
				if ($geo > 0 ) {
					$addr = $row['location_latitude'] .',+' . $row['location_longitude'] . ',';
				}else{
					$addr = '';
				}
				if (isset ($row[location_street]) && isset ($row[location_city]) && isset ($row[location_state])) {
					$addr .= $row['location_street'] . ',' . $row['location_city'] . ',' . $row['location_state'];
					$addr .= ',' . $row['location_country'] ;
				}
				$addr .= '+(' . $row[location_name] . ')&iwloc=A&hl=en';
				$addurl = preg_replace('/\s+/', '+', $addr);
				echo  "<A HREF=\"http://maps.google.com/maps?q=$addurl&sensor=false\">";
				echo  "<IMG SRC=/images/smallballs/purpleball.gif BORDER=0></A>";

				echo "</TD>\n";
				//
				// Number of members
				//
				echo "<TD class=tdrs>";
					echo "$row[count]\n";
				echo "</TD>\n";


				foreach ($ALLFIELD as $f) {

					$wid = $row['igroup_rep'];
					// Stripslashes 
					if (get_magic_quotes_gpc()) { 
						$display = stripslashes($row[$f]); 
					}else{
						$display = $row[$f];
					}

					if ( $f == "igroup_cen" ) {
						$display = $Center[$row[$f]];
					}

					if (isset ( $Cloak[$wid])){
						if ($f == "war_hphone" ) {
							$display = '*';
						}
						if ($f == "war_wphone" ) {
							$display = '*';
						}
						if ($f == "war_cphone" ) {
							$display = '*';
						}
					}

					if ( $f == "igroup_reg" ) {
						$display = $Region[$row[$f]];
					}

					if ( $f == "igroup_rep" ) {
						$display = "<A HREF=/warrior.phpx?war_id=$row[$f]&Action=View>$row[war_fname] $row[war_lname]</A>";
					}

					if ( $f == "location_id" ) {
						$lid = $row['location_id'];
						$display = "<A HREF=/fulllocation.phpx?location_id=$lid";
						$display .= "&Action=View>";
						$display .= "$row[location_name]</A>";
					}

					if ( $f == "igroup_name" ) {
						$display = "<A HREF=/warrior.phpx?igroup_id=$row[igroup_id]";
						$display .= "&in_igroup=Yes&center_id=$row[igroup_cen]&Action=Query>";
						$display .= "$row[$f]</A>";
					}
					
					if (in_array($f, $SHOW)) {
						$css = "tdcs";
						if (array_key_exists($f, $JustifyCss)) {
							$css = $JustifyCss[$f];
						}
						echo "<TD VALIGN=TOP class=$css>";
						if (in_array($f, $LINK)) {
							echo "<A HREF=";
							echo "$_SERVER[PHP_SELF]";
							echo '?';
							$url = preg_replace('/\s+/', '+', $row[$f]);
							echo "$f=${url}&"; 
							echo "$drilldown";
							$action = preg_replace('/\s/', '+', $_REQUEST['Action']);
							echo "&Action=$action>";
							echo "$display</A>\n";
						}else{
							echo "$display\n";
						}
						echo "<BR></TD>\n";
					}
				}
			}
			echo "</TABLE>\n";

	  		if ($_REQUEST['Action'] == "Manage My I-Group" ) {
				show_my_igroup_rosters();
			}

			echo "</CENTER>\n";
	  	}//if ($_REQUEST['Action'] == "Query" || "List")) {

		//----------------------------------------------------------------------
	  	// New Entry Form
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "New"
	  		|| $_REQUEST['Action'] == "New I-Group"
			) {
			$caadbh = caa_connect();

			$dsql = "SELECT field_name, choice from menu where table_name = 'igroup'";
			$dsql .= " AND is_default = 'Y'";

			echo "<P class=trace>$dsql</P>\n"; // DEVONLY
			$Default = array();
			$Default = get_menu_array($dsql);
			$Default['igroup_cen'] = $_SESSION['center_id'];
			$Default['igroup_rep'] = $_SESSION['war_id'];
			print_r($Default);// DEVONLY

			$menuitems = array();
			//
			// Get List of I-Group Reps
			//
			$AllRep = array();
			$AllRep = get_rep_list();

			//
			// Get Field Labels, customize some
			//
			$fieldlabel = get_field_labels('igroup','igroup');
			// TODO: Update messages table
			$fieldlabel['location_id'] = 'Location Name';
			$fieldlabel['igroup_cen'] = 'Center';
			$fieldlabel['igroup_reg'] = 'I-Group Region';
			$fieldlabel['igroup_name'] = 'I-Group Name';

			// Incoming from fulllocation link
			if (isset ($_REQUEST['location_id'] ) ) {
				$Default['location_id'] = $_REQUEST['location_id'];
			}

			unset($fieldlabel['igroup_id']);
			//echo "<PRE>\n"; // DEVONLY
			//print_r($RequiredField); // DEVONLY
			//echo "</PRE>\n"; // DEVONLY

			echo "<P class=trace>If this is at a new location (not one in the picklist), \n";
			echo " <A HREF=/fulllocation.phpx?Action=New>create</A> the location first\n";
			echo " to enable the google map locator functionality.";
			echo "</P>\n";

			echo "<P class=trace>For help on registering a new I-Group, see";
			echo " <A HREF=/help.php?table_name=igroup&context=New+I-Group+Entry&Action=Help>";
			echo " tutorial</A>, or click on row labels in left column for details on that item.";
			echo " <BR><B>Note</B>: Your I-Group Rep must have <A HREF=$WICCFG[WICURL]/login.php>logged in</A>";
			echo " to the USA I-Group Portal to appear in the I-Group Rep picklist.\n";
			echo "</P>\n";

			echo "<CENTER>\n";
			echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
			echo "<TABLE id=igroups_new_form BORDER>\n";

			foreach ( $RequiredField as $fieldname => $msg) {
				$val = $fieldlabel[$fieldname];
				
				echo "<TR>\n";
				echo "<TD VALIGN=TOP CLASS=tdls>";
				echo "<A HREF=/help.php?table_name=igroup&field_name=${fieldname}&help_type=Explanation&Action=Help>";
				echo "$val</A></TD>\n";
				echo "<TD VALIGN=TOP class=tds>";

				if (array_key_exists($fieldname, $FieldType)) {

					if ( $FieldType[$fieldname] == "Menu" ) {
						$menusql = $Menu[$fieldname];
						$menuitems = get_menu($menusql);
						sort($menuitems);
						print "<P class=trace>Menu: $menusql</P>\n"; // DEVONLY
						spew_select_menu($fieldname,'',$Default[$fieldname],$menuitems);

					}

					if ($FieldType[$fieldname] == "MenuArray" ) {
						$menusql = $Menu[$fieldname];
						$menuitems = get_menu_array($menusql);

						//mysql> desc igroup_regions;
						//+--------------+-----------------------+------+-----+---------+----------------+
						//| Field		| Type				  | Null | Key | Default | Extra		  |
						//+--------------+-----------------------+------+-----+---------+----------------+
						//| igrpreg_id   | smallint(11) unsigned | NO   | PRI | NULL	| auto_increment |
						//| igrpreg_name | varchar(40)		   | NO   |	 |		 |				|
						//| igrpreg_cen  | int(11) unsigned	  | NO   |	 | 1	   |				|
						//| igrpreg_rep  | int(10) unsigned	  | YES  |	 | NULL	|				|
						//+--------------+-----------------------+------+-----+---------+----------------+


						//mysql> desc center;
						//+-------------+--------------+------+-----+---------+----------------+
						//| Field	   | Type		 | Null | Key | Default | Extra		  |
						//+-------------+--------------+------+-----+---------+----------------+
						//| center_id   | int(11)	  | NO   | PRI | NULL	| auto_increment |
						//| center_name | varchar(35)  | NO   |	 |		 |				|
						//| short_name  | varchar(35)  | NO   |	 |		 |				|
						//| center_abbr | varchar(6)   | NO   |	 |		 |				|
						//| web_address | varchar(50)  | NO   |	 |		 |				|
						//| contact	 | varchar(50)  | NO   |	 |		 |				|
						//| contactName | varchar(255) | NO   |	 |		 |				|
						//| caaStatus   | varchar(255) | NO   |	 |		 |				|
						//| caa_address | varchar(80)  | YES  |	 | NULL	|				|
						//+-------------+--------------+------+-----+---------+----------------+

						if ($fieldname == 'igroup_reg') {
							$menusql = "SELECT DISTINCT r.igrpreg_id, r.igrpreg_name, c.center_abbr ";
							$menusql .= " FROM igroup_regions r, center c ";
							$menusql .= " WHERE r.igrpreg_cen = c.center_id";
							if ( isset ( $_SESSION['center_id'] ) ) {
								$cid = $_SESSION['center_id'];
								$menusql .= " AND c.center_id = '$cid'";
							}
							$result = mysql_query($menusql);
							$menuitems = array();
							while ($row =  mysql_fetch_array($result, MYSQL_ASSOC)) {
								$rid = $row['igrpreg_id'];
								$menuitems[$rid] = $row['center_abbr'] . ': ' . $row['igrpreg_name'];
							}
							asort($menuitems);
						}

						if ($fieldname == 'location_id') {
							$menuitems['3'] = 'New I-Group Location';
							spew_select_hash_menu($fieldname,'3','',$menuitems);
						}else{
							spew_select_hash_menu($fieldname,$Default[$fieldname],'',$menuitems);
						}
						print "<P class=trace>MenuArray: $menusql</P>\n"; // DEVONLY


					}
					if ($FieldType[$fieldname] == "RepMenu" ) {
						spew_select_hash_menu($fieldname, $Default['igroup_rep'],'',$AllRep);
					}
					if ($FieldType[$fieldname] == "TextArea" ) {
						echo "<TEXTAREA NAME=$fieldname></TEXTAREA>";
					}
				}else{
					echo "<INPUT TYPE=TEXT NAME=$fieldname>";
				}

				echo "</TD>\n";
			}

			echo "</TABLE>\n";
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"Insert New Entry\">\n";
			echo "</FORM>\n";
			echo "</CENTER>\n";
		}


		//----------------------------------------------------------------------
	  	// Edit
		//----------------------------------------------------------------------
	  	if ($_REQUEST[Action] == "Edit")  {

			if (! array_key_exists('igroup_id', $_REQUEST)) {
				die ("No I-Group Id Set for Edit function. Contact Administrator") ;
			}else{
				$igid = $_REQUEST['igroup_id'];
			}
			// Input Validation
			if ( empty ($igid) ){
				die("ERROR: No I-Group ID Sent to Edit function");
			}
			if (! is_numeric ($igid) ){
				die("ERROR: I-Group ID needs to be numeric. Contact administrator");
			}

			$AllRep = array();
			$FieldType['igroup_rep'] = 'RepMenu';
			caa_connect();

			//
			// Get info on this I-Group
			//
			$Igroup = array();
			$sql = "SELECT * FROM igroup WHERE igroup_id = '$igid'";
			$result = mysql_query($sql);
			$Igroup = mysql_fetch_array($result, MYSQL_ASSOC) ;
			echo "<PRE>\n";	 // DEVONLY
			print_r($Igroup);   // DEVONLY
			echo "</PRE>\n";	 // DEVONLY

			if (array_key_exists('igroups', $_SESSION)) {
				$i_am_member_of = array();
				$i_am_member_of = explode('|', $_SESSION['igroups']);
				print_r($i_am_member_of); // DEVONLY
			}

			if (array_key_exists('access', $_SESSION)) {
				//-------------------------------------------------------------
				// If you are not the rep and you don't have sufficient access
				//-------------------------------------------------------------
				if ( $_SESSION['access'] < $IGCFG['EDITLEVEL'] 
					&& $_SESSION['war_id'] != $Igroup['igroup_rep'] 
					&& $_SESSION['igroup_id'] != $igid
					&& (! in_array($igid, $i_am_member_of)) ) {

					echo "<P class=trace>Your access level is $_SESSION[access].";
					echo "You need access level (Level $IGCFG[EDITLEVEL]), or be a member of the igroup to edit.\n"; 
					echo "</P>\n";
	  				$_REQUEST['Action'] = "View";
				}else{
					$AllRep = get_rep_list();
				}
			}else{
				echo "<H2>For Edit capability, you will need to ";
				echo "<A HREF=/login.phpx>Login</A></H2>\n";
				spew_footer($FMT);
				exit;
			}

			//
			// Get info on your rep
			//
			$Rep = array();
			$repid = $Igroup['igroup_rep'];
			$repsql = "SELECT * FROM warrior WHERE war_id = '$repid'";
			$represult = mysql_query($repsql);
			$Rep = mysql_fetch_array($represult, MYSQL_ASSOC) ;

			//echo "<pre>\n";// DEBUG DEVONLY
			//print_r($Rep); //DEBUG DEVONLY
			//echo "</pre>\n";// DEBUG DEVONLY

			//
			// Special Lookup for Center name to id match
			//
			$Center = array();
			$csql = "SELECT DISTINCT center_id, short_name FROM center";
			$Center = get_menu_array($csql);

			//
			// Special Lookup for Region name to id match
			//
			$Region = array();
			$rsql = "SELECT DISTINCT igrpreg_id, igrpreg_name from igroup_regions";
			$Region = get_menu_array($rsql);

			echo "<P class=trace>Edit the";
			echo " <A HREF=/fulllocation.phpx?location_id=$Igroup[location_id]&Action=Edit>full location</A>";
			echo " to enable Google maps display.\n";
			echo "</P>\n";

			echo "<CENTER>\n";
			echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
			echo "<TABLE id=igroups_edit_form BORDER>\n";

			$fieldlabel = get_field_labels('igroup','igroup');

			//
			// Kluge for pretty labels
			//
			// TODO: Update messages table
			$fieldlabel[igroup_cen] = "Geographical Center";
			$fieldlabel[igroup_reg] = "I-Group Region";
			$fieldlabel[location_id] = "Location";
			unset($fieldlabel['igroup_id']);

			foreach ($fieldlabel as $fieldname => $label) {

				// Stripslashes 
				if (get_magic_quotes_gpc()) { 
					$display = stripslashes( $Igroup[$fieldname]) ;
					$val = stripslashes($Igroup[$fieldname]);
				}else{
					$display = $Igroup[$fieldname];
					$val = $Igroup[$fieldname];
				}

				if ( $fieldname == "igroup_rep" ) {
					$display = $Rep[war_fname] . ' ' . $Rep[war_lname] . ', ' ;
					$display .= "<A HREF=mailto:" . $Rep[war_email] . ">" . $Rep[war_email] . "</A>";
					//
					// Cell Phone
					//
					if ( $Rep[war_cphone] ) {
						$display .= ', Cell: ' . $Rep[war_cphone];
					}
					//
					// Home Phone
					//
					if ( $Rep[war_hphone] ) {
						$display .= ', Home: ' . $Rep[war_hphone];
					}
					//
					// I-Group name link is roster from warrior table
					//
					if ( $f == "igroup_name" ) {
						$display = "<A HREF=/warrior.phpx?igroup_id=$row[igroup_id]";
						$display .= "&in_igroup=Yes&center_id=$row[igroup_cen]&Action=Query>";
						$display .= "$row[$f]</A>";
					}
				}
				//
				// Create name and link to view location
				//
				if ( $fieldname == "location_id" ) {
					$lid = $row['location_id'];
					if (! empty ( $lid ) ) {
						$lsql = "SELECT location_name from fulllocation where location_id = '$lid'";
						$LocName = get_value($lsql);
						$display = "<A HREF=/fulllocation.phpx?location_id=$lid&Action=View>";
						$display .= "$LocName</A>";
					}
				}

				if ( $fieldname == "igroup_reg" ) {
					$display = $Region[$display];
				}

				if ( $fieldname == "igroup_cen" ) {
					$display = $Center[$display];
				}

				echo "<TR>";

				echo "<TD class=tdls>";
				echo "<A HREF=/help.phpx?table_name=igroup&field_name=$fieldname&help_type=Explanation&Action=Help>";
				echo "$label</A>\n";
				echo "</TD>\n";

				echo "<TD VALIGN=TOP class=tds>";
				if (array_key_exists($fieldname, $FieldType)) {

					if ( $FieldType[$fieldname] == "Menu" ) {
						$menusql = $Menu[$fieldname];
						$menuitems = get_menu($menusql);
						sort($menuitems);
						spew_select_menu($fieldname, $val,'',$menuitems);
					}

					if ($FieldType[$fieldname] == "MenuArray" ) {
						$menusql = $Menu[$fieldname];
						$menuitems = get_menu_array($menusql);
						spew_select_hash_menu($fieldname, $val,'',$menuitems);
					}

					if ($FieldType[$fieldname] == "RepMenu" ) {
						spew_select_hash_menu($fieldname, $val,'',$AllRep);
					}

					if ($FieldType[$fieldname] == "TextArea" ) {
						echo "<TEXTAREA NAME=$fieldname>$val</TEXTAREA>";
					}

				}else{
					echo "<INPUT TYPE=TEXT NAME=$fieldname VALUE=\"$val\">\n";
				}
				echo "</TD>\n";
			}//Endforeach
			echo "</TABLE>\n";
			echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$_REQUEST[igroup_id]>\n";
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=Update>\n";
			echo "</FORM>\n";

			echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=View>\n";
			echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$igid>\n";
			echo "</FORM>\n";

			echo "</CENTER>\n";
	  	}//if ($_REQUEST['Action'] == "Edit") 

		//----------------------------------------------------------------------
	  	// View I-Group
		//----------------------------------------------------------------------
	  	if ($_REQUEST['Action'] == "View" ) {

			echo "<P class=trace>Entering View</P>\n"; // DEVONLY
			if (! array_key_exists('igroup_id', $_REQUEST)) {
				die ("No I-Group Id Set") ;
			}else{
				// SECURITY TODO: Verify integer
				$igid = $_REQUEST['igroup_id'];
			}

			$AllRep = array();
			$Center = array();
			$Igroup = array();
			$Location = array();
			$Rep = array();

			caa_connect();

			//
			// Get info on this I-Group
			//
			$sql = "SELECT * FROM igroup WHERE igroup_id = '$igid'";
			$result = mysql_query($sql);
			$Igroup = mysql_fetch_array($result, MYSQL_ASSOC) ;
			echo "<PRE>\n";	 // DEVONLY
			echo "I-Group\n";   // DEVONLY
			print_r($Igroup);   // DEVONLY
			echo "</PRE>\n";	// DEVONLY

			//
			// Get info on the location of this I-Group
			//
			$lid = $Igroup['location_id'];
			if (empty ( $lid ) ){
				echo "<H2>No Location ID</H2>\n";   // ERROR DEVONLY
			}else{
				echo "<H2>Location ID Exists</H2>\n";   // ERROR DEVONLY
				$lsql = "SELECT * from fulllocation where location_id = '$lid'";
				echo "<P class=trace>$sql</P>\n"; // DEVONLY
				$lresult = mysql_query($lsql);
				$Location = mysql_fetch_array($lresult, MYSQL_ASSOC) ;
			}

			//
			// Get info on the rep for this I-Group
			//
			$wsql = "SELECT * FROM warrior WHERE war_id = '$Igroup[igroup_rep]'";
			$wresult = mysql_query($wsql);
			$Rep = mysql_fetch_array($wresult, MYSQL_ASSOC) ;

			//
			// Special Lookup for Center name to id match
			// TODO: Should be join... performance/scalability issue
			//
			$csql = "SELECT DISTINCT center_id, short_name FROM center";
			$Center = get_menu_array($csql);

			//
			// Special Lookup for Region name to id match
			// TODO: Should be join... performance/scalability issue
			//
			$Region = array();
			$rsql = "SELECT DISTINCT igrpreg_id, igrpreg_name from igroup_regions";
			$Region = get_menu_array($rsql);

			echo "<P class=trace>Click on name of I-Group to view current roster";
			echo ". Click on Location link to see map and address";
			echo ".</P>\n";

			$fieldlabel = get_field_labels('igroup','igroup');

			//
			// Kluge for pretty labels
			// TODO: Should tweak this in message table
			//
			$fieldlabel['igroup_cen'] = "Geographical Center";
			$fieldlabel['igroup_reg'] = "I-Group Region";
			$fieldlabel['location_id'] = "Location";

			echo "<CENTER>\n";

			// Begin Outer Table
			echo "<TABLE BORDER=3 CELLSPACING=3>";
			echo "<TH>I-Group Information</TH>\n";
			echo "<TH>I-Group Location Details</TH>\n";
			echo "<TR>\n";
			//------------------------------------------------------------------------
			// Begin Left Column, I-Group Info
			//------------------------------------------------------------------------
			echo "<TD VALIGN=TOP ALIGN=CENTER WIDTH=50%>\n";
				//
				// Get details from Location
				//

				echo "<P class=trace>Clicking on the label link in left column provides more information.</P>\n";
				echo "<TABLE id=igroup_view_form BORDER WIDTH=90%>\n";
	
				foreach ($IGROUPFIELD as $fieldname) {
					$val = $fieldlabel[$fieldname];
	
					$display = stripslashes($Igroup[$fieldname]);
	
					//
					// Create name and link for I-Group Rep
					//
					if ( $fieldname == "igroup_rep" ) {
						$display = "<A HREF=/warrior.php?war_id=$Rep[war_id]&Action=View>";
						$display .= $Rep[war_fname] . ' ' . $Rep[war_lname] ;
						$display .= "</A>\n";
					}
	
					//
					// Create name and link to view/add location
					//
					if ( $fieldname == "location_id" ) {
						if ( empty ( $lid ) ) {
							$display = "<A HREF=/fulllocation.phpx?&Action=New>";
							$display .= "None, click here to add</A>";
						}else{
							$LocName = $Location['location_name'];
							$display = "<A HREF=/fulllocation.phpx?location_id=$lid&Action=View>";
							$display .= "$LocName</A>";
						}
					}
	
					if ( $fieldname == "igroup_reg" ) {
						$display = $Region[$display];
					}
	
					if ( $fieldname == "igroup_cen" ) {
						$display = $Center[$display];
					}
	
					if ( $fieldname == "igroup_name" ) {
						$display = "<A HREF=/warrior.phpx?igroup_id=$igid&Action=Query";
						$display .= "&in_igroup=Yes>$Igroup[igroup_name]</A>";
					}
	
					echo "<TR><TD class=tdls>";
					echo "<A HREF=/help.phpx?table_name=igroup&field_name=$fieldname&help_type=Explanation&Action=Help>";
					echo "$val</A>";
					echo "</TD>\n";

					echo "<TD VALIGN=TOP class=tds>";
					echo "$display<BR>";
					echo "</TD>\n";

				}//Endforeach
				echo "</TABLE>\n";


				//
				// If this I-Group is one I belong to, show me the roster
				//
				if ( $_SESSION['igroup_id'] == $igid ) {
					$show_my_igroup = "True";
				}
				//
				// Also Look at array $_SESSION['igroups'] (I belong to multiple I-Groups)
				// To check membership of all possible I-Groups
				//
				if ( isset ($_SESSION['igroups']) ) {
					$myig = array();
					$myig = explode('|', $_SESSION['igroups']) ;
					foreach ($myig as $ig ) {
						if ($ig == $igid) {
							$show_my_igroup = "True";
						}
					}
				}
				//
				// Option to Edit
				//
				echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
				echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$igid>\n";
				if ( $show_my_igroup == "True" 
					|| $_SESSION['access'] >= $IGCFG['EDITLEVEL']) {
					echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=Edit>\n";
				}
				//
				// Option to Delete
				//

				if ( $_SESSION['access'] >= $IGCFG['ADMINLEVEL'] ) {
					echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=Delete>\n";
				}

				echo "</FORM>\n";

	
			// End Left Column, I-Group Info
			echo "</TD>\n";
			//------------------------------------------------------------------------
			// Begin Right Column, Location Info
			//------------------------------------------------------------------------
			echo "<TD VALIGN=TOP ALIGN=CENTER WIDTH=50%>\n";

				$LOCFIELD = array(
					'location_name',
					'center_id',
					'location_type',
					'location_street',
					'location_city',
					'location_state',
					'location_zip',
					'location_county',
					'location_country',
					'location_capacity',
					'location_url',
					'map_url',
					'contact_id',
					'contact_name',
					'contact_phone',
					'contact_email',
					'location_latitude',
					'location_longitude',
					'location_description',
					'driving_directions',
					'location_notes'
				);

				$menulist = array();
				//
				// Get Field Labels
				//
				$lfieldlabel = array();
				$lfieldlabel = get_field_labels('fulllocation','location');

				//
				// Goggle map link blurb
				//
				$nurl = preg_replace('/\s+/', '+', $Location['location_name']);
	 
				echo "<P class=trace>";
				echo "If the latitude and longitude are included, you can see a ";
				echo "<A HREF=\"http://maps.google.com/maps?q=$Location[location_latitude],";
				echo "+$Location[location_longitude]+($nurl)&iwloc=A&hl=en\">";
				echo "Google map</A> of this location.";
				echo "</P>\n";
	
				echo "<TABLE id=igroup_location_view_form BORDER WIDTH=90%>\n";

				foreach ($LOCFIELD as $fieldname ) {
					$label = $lfieldlabel[$fieldname];
					echo "<TR>\n";
					echo "<TD VALIGN=TOP class=tdls>";
					echo "<A HREF=help.php?table_name=fulllocation&field_name=$fieldname&help_type=Explanation&Action=Help>";
					echo "$label</A></TD>\n";
					echo "<TD VALIGN=TOP class=tds>";
	
					$display = stripslashes($Location[$fieldname]);

					//
					// View Entry Lookup Map Translations (id -> othertable.name for foreign keys)
					//
					if ( $fieldname == "contact_id" ) {
						$cid = $Location[$fieldname];
						$sql = "SELECT war_fname, war_lname from warrior where war_id = '$Location[contact_id]'";
						$name = array();
						$name = get_menu($sql);
						$fullname = implode(' ',  $name);
						$display = "<A HREF=$WICCFG[WICURL]/warrior.php?war_id=$cid&Action=View>$fullname</A>";
					}

					if ( $fieldname == "center_id" ) {
						$sql = "SELECT center_name from center where center_id = '$Location[center_id]'";
						$display = get_value($sql);
					}
	
					echo "$display<BR>";
					echo "</TD>\n";
				}//Endforeach fieldname

				echo "</TABLE>\n";

				echo "<FORM ACTION=/fulllocation.php TYPE=POST>\n";
				echo "<INPUT TYPE=HIDDEN NAME=location_id VALUE=$Location[location_id]>\n";
				echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=Edit>\n";
				echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=View>\n";
				echo "</FORM>\n";
			//------------------------------------------------------------------------
			// End Begin Right Column, Location Info
			echo "</TD>\n";

			//------------------------------------------------------------------------
			// End Outer Table
			//------------------------------------------------------------------------
			echo "</TABLE>\n";
			echo "</CENTER>\n";
	
			if ( isset($show_my_igroup) ) {
				show_my_igroup_rosters();
			}

	  	}//Endif ($_REQUEST['Action'] == "View"))

	}else{
		spew_header($FMT);
		spew_query_form();
	}

	spew_footer($FMT);
	//----------------------------------------------------------------
	// Function spew_query_form
	//----------------------------------------------------------------
	function spew_query_form() {
		$caadbh = caa_connect();
		$list = array();
		$list2 = array();
		$list3 = array();
		$iamrepfor ='';
		//
		// Add options if you are an I-Group Rep
		//
		//
		if ( array_key_exists('IamIgRepFor', $_SESSION)) {
			$iamrepfor = $_SESSION['IamIgRepFor'];
			echo "<P class=trace>Upon entry to spew_query_form, Session IamIgRepFor is $iamrepfor</P>\n"; // DEVONLY
		}else{
			echo "<P class=trace>Upon entry to spew_query_form, Session IamIgRepFor NOT set</P>\n"; // DEVONLY
			if ( array_key_exists('war_id', $_SESSION)) {
				$wid = $_SESSION['war_id'];
				//
				// Verify  non-null 
				//
				if ( ! empty ( $wid)) { 
					$sql = "SELECT igroup_id from igroup WHERE igroup_rep = '$wid'";
					echo "<P class=trace>$sql</P>\n"; // DEVONLY
					$iamrepfor = get_value($sql);
					if ( empty ( $iamrepfor)) { 
						echo "<P class=trace>You are clearly not an I-Group rep...</P>\n"; // DEVONLY
					}else{
						$_SESSION['IamIgRepFor'] = $iamrepfor;
						echo "<P class=trace>Seeting $Rid to $iamrepfor</P>\n"; // DEVONLY
					}
				}
			}
		}
		$igroupid = $_SESSION['igroup_id'];

		//
		// Spew Form Blurb
		//
		echo "<P class=trace>\n";
		echo "Select the Center, I-Group Region, and/or Name and click on <B>List</B> button";
		echo " to see list of matching I-Groups. Name search matches any part of I-Group name.";
		echo " To create a new I-Group, find or create the <A HREF=/fulllocation.php>location</A>\n";
		echo " where it meets and click on the <I>Register a new I-Group that meets here</I>\n";
		echo " link from the <I>View</I> of that location.\n";
		echo " For help, see";
		echo " <A HREF=/help.php?table_name=igroup&field_name=Overview&Action=Help>overview</A>.\n";
		echo "</P>\n";
		echo "<CENTER>\n";
		echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
		echo "<TABLE id=igroups_query_form BORDER>\n";
		if ( $_SESSION['access'] >= $IGCFG['ADMINLEVEL'] ) {
			echo "<TH class=ths>ID</TH>\n";
		}
		echo "<TH class=ths>Center</TH>\n";
		echo "<TH class=ths>Name</TH>\n";
		echo "<TH class=ths>Night</TH>\n";
		echo "<TH class=ths>Status</TH>\n";
		//echo "<TH class=ths>City</TH>\n";
		echo "<TH class=ths>I-Group Region</TH>\n";
		//echo "<TH class=ths>Country</TH>\n";
		//echo "<TH class=ths>Zip</TH>\n";
		echo "<TH class=ths>Sort by</TH>\n";

		echo "<TR>\n";
		//
		// ID
		//
		if ( $_SESSION['access'] >= $IGCFG['ADMINLEVEL'] ) {
			echo "<TD class=tds>\n";
			echo "<INPUT TYPE=TEXT SIZE=6 NAME=igroup_id>\n";
			echo "</TD>\n";
		}


		//
		// Center
		//
		echo "<TD class=tds>\n";
		$sql = "SELECT DISTINCT i.igroup_cen, c.short_name FROM igroup i, center c ";
		$sql .= " WHERE i.igroup_cen = c.center_id ORDER BY c.short_name";
		$list = get_menu_array($sql);
		$igid = $_SESSION['center_id'];
		if ( isset ( $_REQUEST[igroup_cen] ) ) {
			$igid = $_REQUEST[igroup_cen];
		}
		spew_select_hash_menu('igroup_cen',$igid,'All',$list);
		echo "</TD>\n";

		//
		// Name
		//
		echo "<TD class=tds>\n";
        echo "<INPUT TYPE=TEXT NAME=igroup_name>\n";
		echo "</TD>\n";

		//
		// Night
		//
		echo "<TD class=tds>\n";
		$sql = "SELECT DISTINCT igroup_night from igroup order by igroup_night";
		$list = get_menu($sql);
		spew_select_menu('igroup_night',$_REQUEST['igroup_night'],'All',$list);
		echo "</TD>\n";

		//
		// Status
		//
		echo "<TD class=tds>\n";
		$sql = "SELECT DISTINCT igroup_status from igroup order by igroup_status";
		$list = get_menu($sql);
		spew_select_menu('igroup_status',$_REQUEST['igroup_night'],'All',$list);
		echo "</TD>\n";

		//
		//
		// City
		//
		//echo "<TD class=tds>\n";
		//#$sql = "SELECT DISTINCT igroup_city from igroup order by igroup_city";
		//$sql = "SELECT DISTINCT f.location_city from fulllocation f, igroup i ";
		//$sql .= " WHERE f.location_id = i.location_id order by f.location_city";
		//$list = get_menu($sql);
		//spew_select_menu('location_city',$_REQUEST['location_city'],'All',$list);
		//echo "</TD>\n";

		//
		// I-Group Region
		//
		echo "<TD class=tds>\n";
		$isql = "SELECT DISTINCT r.igrpreg_id, r.igrpreg_name, c.center_abbr ";
		$isql .= " FROM igroup_regions r, center c ";
		$isql .= " WHERE r.igrpreg_cen = c.center_id ";
		$isql .= " ORDER BY c.center_abbr, r.igrpreg_name";
		$rresult = mysql_query($isql);
		$list = array();
		while ($row =  mysql_fetch_array($rresult, MYSQL_ASSOC)) {
			$igrid = $row['igrpreg_id'];
			$list[$igrid] = $row['center_abbr'] . ': ' . $row['igrpreg_name'];
		}
		spew_select_hash_menu('igroup_reg','','All',$list);
		echo "</TD>\n";

		//
		// Country
		//
		//echo "<TD class=tds>\n";
		//$sql = "SELECT DISTINCT igroup_country from igroup order by igroup_country";
		//$list = get_menu($sql);
		//spew_select_menu('location_country','','All',$list);
		//echo "</TD>\n";

		//
		// Zip
		//
		//echo "<TD class=tds>\n";
		//#$sql = "SELECT DISTINCT igroup_zip from igroup order by igroup_zip";
		//$sql = "SELECT DISTINCT f.location_zip FROM fulllocation f, igroup i ";
		//$sql .= " WHERE i.location_id = f.location_id order by f.location_zip";
		//$list = get_menu($sql);
		//spew_select_menu('location_zip',$_REQUEST['location_zip'],'All',$list);
		//echo "</TD>\n";

		//
		// Sort By
		//
		echo "<TD class=tds>\n";
		$Sortwhat = array (
			'Zip',
			'State',
			'Location',
			'Name',
			'I-Group Region',
			'Country',
			'City'
			);
		sort($Sortwhat);
		spew_select_menu('Sortmeby','Name','Name',$Sortwhat);
		echo "</TD>\n";
		// End Table

		echo "</TR>\n";
		echo "</TABLE>\n";
		// End Form

		//echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=Query>\n";
		//echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"Query Reps\">\n";
		echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=List>\n";
		echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"List Reps\">\n";

		//if ($_SESSION['access'] >= $IGCFG['EDITLEVEL'] ) {
			//echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"New\">\n";
		//}

		//
		// If you are an I-Group Rep or in an I-Group
		//
		if ( $iamrepfor > 0 || array_key_exists('igroup_id', $_SESSION) ){
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"Manage My I-Group\">\n";
			echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"Men Near My I-Group\">\n";
		}
		echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"I-Groups Near Me\">\n";
		echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"My Center\">\n";
		echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"USA Summary\">\n";

		echo "</FORM>\n";
		echo "<P class=trace>Rep ID: $iamrepfor</P>\n"; // DEVONLY
		echo "</CENTER>\n";
	}
	//----------------------------------------------------------------
	// Lookup all warriors for rep list
	// Selects warriors in your center
	//----------------------------------------------------------------
	function get_rep_list() {
		caa_connect();
		//
		//
		$MyAllRep = array();

		$cid = $_SESSION['center_id'];

		$repsql = "SELECT war_id, war_fname, war_lname from warrior";
		if ( isset ( $cid ) ) {
			$repsql .= " WHERE war_center = '$cid'";
		}
		// TODO: Narrow Rep Candidate search to active people via war_status or access_password
		//$repsql .= " AND war_status = 'active' ";	
		// -OR- w.war_id = access_password.warrior_id
		$repsql .= " ORDER BY war_lname, war_fname";

		echo "<P class=trace>Possible Reps: $repsql</P>\n"; // DEBUG DEVONLY

		$represult = mysql_query($repsql);

		while ($row =  mysql_fetch_array($represult, MYSQL_ASSOC)) {
			$id = $row['war_id'];
			$name = $row['war_fname'] . ' ' . $row['war_lname'];
			$MyAllRep[$id] = $name;
		}
		return($MyAllRep);
	}

	//----------------------------------------------------------------
	// Lookup all warriors for rep list
	// Selects warriors in your center
	//----------------------------------------------------------------
	function show_my_igroup_rosters() {
		global $IGCFG;
		caa_connect();
		$roster = array();
		$row = array();
		echo "<P class=trace>Entering show_my_igroup_rosters</P>\n"; // DEVONLY

		//
		// Determine how many I-Groups to loop through
		//
		$alligroups = array();
		//if (array_key_exists('igroups', $_SESSION)){
			//$alligroups = explode('|', $_SESSION['igroups']);
		//}else{
			//$alligroups[] = $_SESSION['igroup_id'];
		//}
		$wid = $_SESSION['war_id'];
		if ( empty ($wid) ){
			die("ERROR: No Warrior ID Sent to show_my_igroup_rosters function");
		}
		if (! is_numeric ($wid) ){
			die("ERROR: Warrior ID needs to be numeric in show_my_igroup_rosters. Contact administrator");
		}

		$sql = "SELECT distinct war_ig_ig from warrior_igroup WHERE war_ig_war = '$wid'";
		$sql .= " AND war_ig_ig > '0' AND ( war_ig_ig < '$IGCFG[MINNONE]' OR war_ig_ig > '$IGCFG[MAXNONE]' )";
		echo "<P class=trace>$sql</P>\n"; // DEVONLY

		$alligroups = get_menu($sql);
		print_r($alligroups); // DEVONLY

		echo "<HR>\n";
		echo "<CENTER><H1>Rosters of My I-Groups</H1></CENTER>\n";
		$today = date('Y-m-d');
		foreach ($alligroups as $igid) {
			echo "<HR>\n";

			//=================================================================
			// Warrior: INITIATED MEN
			//=================================================================
			//-----------------------------------------------------------------
			// Provide Warrior I-Group History Information for Roster
			//-----------------------------------------------------------------
			//
			$sql = "SELECT * from warrior_ighistory WHERE  ";
			$sql .= " igroup_id = '$igid'";
			$sql .= " AND end_date is NULL";

			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
			$History = array();
			$Start = array();

			while ($row =  mysql_fetch_array($result, MYSQL_ASSOC)) {
				$wid = $row['warrior_id'];
				$History[$wid] = $row['start_date'];
				$Start[$wid] = $row['start_date'];
			}

			//echo "<PRE>\n";		// DEVONLY
			//print_r ($History); // DEVONLY
			//echo "</PRE>\n";	// DEVONLY
	
			//-----------------------------------------------------------------
			// Provide Initiated Men Roster of I-Group Members
			//-----------------------------------------------------------------
			//
	
			$sql = "SELECT DISTINCT w.war_id, w.war_fname, w.war_lname, w.war_aname, w.war_city, w.war_state ";
			$sql .= " , i.war_ig_ig, x.igroup_name, x.igroup_rep ";
			$sql .= " FROM warrior w, warrior_igroup i, igroup x";
			$sql .= " WHERE w.war_id = i.war_ig_war AND x.igroup_id = i.war_ig_ig";
			$sql .= " AND i.war_ig_ig = '$igid'";
			$sql .= " ORDER BY x.igroup_name, w.war_lname, w.war_fname ";
	
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
	
			//-----------------------------------------------------------------
			// Print New Member Roster
			//-----------------------------------------------------------------
			//
			echo "<P class=trace>Click on red ball to remove a man from I-Group membership, ";
			echo "yellow ball to see contact info.\n";
			echo " NWTA uninitiated members/visitors shown in grey.";
			echo "</P>\n";
	
			$nsql = "SELECT igroup_name from igroup where igroup_id = '$igid'";
			$name = get_value($nsql);
	
			echo "<CENTER>\n";
			echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
			echo "<TABLE BORDER>\n";
			echo "<TH class=ths COLSPAN=10>$name Current Roster";
			echo "($igid)"; // DEVONLY
			echo "</TH>\n";
			echo "<TR>\n";
	
			echo "<TH class=ths>Remove</TH>\n";
			echo "<TH class=ths>Rep</TH>\n";
			echo "<TH class=ths>View</TH>\n";
			echo "<TH class=ths>First Name</TH>\n";
			echo "<TH class=ths>Last Name</TH>\n";
			echo "<TH class=ths>Animal Name</TH>\n";
			echo "<TH class=ths>City</TH>\n";
			echo "<TH class=ths>State</TH>\n";
			echo "<TH class=ths>Start Date</TH>\n";
			echo "<TH class=ths>Update Start Date (YYYY-MM-DD)</TH>\n";
	
			while ($row =  mysql_fetch_array($result, MYSQL_ASSOC)) {
	
				$cclass = "tdcs";
				$class = "tds";
	
				$wid = $row['war_id'];
				//
				// Highlight I-Group Rep
				//
				if ($wid == $row['igroup_rep']) {
						$class = "tdsltyel";
						$cclass = "tdscltyel";
				}
	
				echo "<TR>\n";

				// Remove
				//echo "<TD class=>";
				echo "<TD class=$cclass>";
				echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$igid&warrior_id=$wid&Action=Exit>";
				echo "<IMG SRC=/images/smallballs/redball.gif BORDER=0></A>\n";
				echo "</TD>\n";
	
				// Rep
				//echo "<TD BGCOLOR=$BGC class=tdcs>";
				echo "<TD class=$cclass>";
				if ( $wid == $row['igroup_rep']) {
					echo "Current";
				}else{
					echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$igid&igroup_rep=$wid&Action=Designate>";
					echo "Designate</A>\n";
				}
				echo "</TD>\n";

				// View
				echo "<TD class=$cclass>";
				echo "<A HREF=/warrior.phpx?war_id=$wid&Action=View>";
				echo "<IMG SRC=/images/smallballs/yellowball.gif BORDER=0></A>\n";
				echo "</TD>\n";
	
				// First Name
				echo "<TD class=$cclass>";
				echo "$row[war_fname]";	
				echo "</TD>\n";
	
				// Last Name
				echo "<TD class=$cclass>";
				echo "$row[war_lname]";	
				echo "</TD>\n";
	
				// Animal Name
				echo "<TD class=$cclass>";
				echo "$row[war_aname]";	
				echo "</TD>\n";
	
				// City
				echo "<TD class=$cclass>";
				echo "$row[war_city]";	
				echo "</TD>\n";
				
				// State
				echo "<TD class=$cclass>";
				echo "$row[war_state]";	
				echo "</TD>\n";
	
				// Start Date
				$dte = $History[$wid];
				echo "<TD class=$cclass>";
				echo "$dte<BR>";	
				echo "</TD>\n";
	
				// Update Start Date Microform
				echo "<TD class=$cclass>";
					echo "<INPUT TYPE=TEXT NAME=\"start_date_warrior_${igid}_${wid}\" SIZE=10 MAXLENGTH=10>\n";
				echo "</TD>\n";
	
			}//Endhile $row.. for Initiated Man I_Group Roster
	
			//=================================================================
			// VISITORS: UNINITIATED MEN
			//=================================================================
			//-----------------------------------------------------------------
			// Provide Visitor I-Group History Information for Roster
			//-----------------------------------------------------------------
			//
			// Get Start Date for each Unitiated Member
			//
			$sql = "SELECT igvisitor_id, start_date FROM igvisitor_ighistory ";
			$sql .= " WHERE igroup_id = '$igid'";
			$Start = array();
			$Start = get_menu_array($sql);
	
			//
			// Get All currently seated visitor members
			//
			$sql = "SELECT * from igvisitor_ighistory WHERE  ";
			$sql .= " igroup_id = '$igid'";
			$sql .= " AND end_date is NULL ";
	
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$visitorresult = mysql_query($sql);

			$VisitorHistory = array();
			while ($row =  mysql_fetch_array($visitorresult, MYSQL_ASSOC)) {
				$vid = $row['igvisitor_id'];
				$VisitorHistory[$vid] = $row['start_date'];
			}
	
			//-----------------------------------------------------------------
			// Provide UnInitiated Men Visitor Roster of I-Group Members
			//-----------------------------------------------------------------
			//
	
			$sql = "SELECT v.igvisitor_id, v.igvisitor_fname, v.igvisitor_lname,";
			$sql .= " v.igvisitor_aname, v.igvisitor_city, v.igvisitor_state,";
			$sql .= " i.igroup_id, x.igroup_name ";
			$sql .= " FROM igvisitor v, igvisitor_igroup i, igroup x";
			$sql .= " WHERE v.igvisitor_id = i.igvisitor_id AND x.igroup_id = i.igroup_id";
			$sql .= " AND i.igroup_id = '$igid'";
			$sql .= " ORDER BY x.igroup_name, v.igvisitor_lname, v.igvisitor_fname ";
	
			echo "<P class=trace>$sql</P>\n"; // DEVONLY
			$result = mysql_query($sql);
	
			//-----------------------------------------------------------------
			// UnInitiated Men
			//-----------------------------------------------------------------
			//
			while ($row =  mysql_fetch_array($result, MYSQL_ASSOC)) {
				$vid = $row['igvisitor_id'];

				echo "<TR>\n";
	
				//
				// Vistor Remove
				//
				echo "<TD class=tdscgray>";
				echo "<A HREF=$_SERVER[PHP_SELF]?igroup_id=$igid&igvisitor_id=$vid&Action=Visitor+Exit>";
				echo "<IMG SRC=/images/smallballs/redball.gif BORDER=0></A>\n";
				echo "</TD>\n";

				//
				// Vistor Rep (N/A)
				//
				echo "<TD class=tdscgray>";
				echo "<BR>";
				echo "</TD>\n";

				//
				// Vistor View
				//
				echo "<TD class=tdscgray>";
				echo "<A HREF=/igvisitor.phpx?igvisitor_id=$vid&Action=View>";
				echo "<IMG SRC=/images/smallballs/yellowball.gif BORDER=0></A>\n";
				echo "</TD>\n";
	
				//
				// Visitor first name
				//
				echo "<TD class=tdscgray>";
				echo "$row[igvisitor_fname]";	
				echo "</TD>\n";
	
				//
				// Vistor last name
				//
				echo "<TD class=tdscgray>";
				echo "$row[igvisitor_lname]";	
				echo "</TD>\n";

				//
				// Vistor animal name
				//
				echo "<TD class=tdscgray>";
				echo "$row[igvisitor_aname]";	
				echo "</TD>\n";
	
				//
				// Vistior city
				//
				echo "<TD class=tdscgray>";
				echo "$row[igvisitor_city]";	
				echo "</TD>\n";
				
				//
				// Visitor state
				//
				echo "<TD class=tdscgray>";
				echo "$row[igvisitor_state]";	
				echo "</TD>\n";
	
				//
				// Visitor Start Date
				//
				$dte = $VisitorHistory[$vid];
				echo "<TD class=tdscgray>";
				echo "$dte<BR>";	
				echo "</TD>\n";
	
				//
				// Visitor Update Start Date
				//
				echo "<TD class=tdscgray>";
					echo "<INPUT TYPE=TEXT NAME=\"start_date_visitor_${igid}_${vid}\" SIZE=10 MAXLENGTH=10>\n";
				echo "</TD>\n";
	
			}//Endhile $row.. for UnInitiated I-Group Roster
			echo "</TABLE>\n";
			echo "<INPUT TYPE=SUBMIT NAME=\"Action\" VALUE=\"Update Start Dates\">\n";
			echo "</FORM>\n";
			echo "<P>\n";
	
			//
			// Print form to get query list for adding new member
			//
	
			echo "<TABLE>\n";
			echo "<TR><TD ALIGN=CENTER>\n";
	
				echo "<P class=trace>";
				echo "Enter last name or email and";
				echo "<BR> click <I>New Initiated Member</I> button.";
				echo "<BR>For more information, see";
				echo "<A HREF=/help.php?table_name=igroup&field_name=Associate&Action=Help>";
				echo " help</A>.";
				echo "</P>\n";

				echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
				echo "<TABLE BORDER=3 id=add_initiated_man_form>\n";
				echo "<TH COLSPAN=2>Add Initiated Man as New Member</TH>\n";
				//echo "<TR><TD class=tdls>\n";
				//echo "First Name";
				//echo "</TD><TD> \n";
				//echo "<INPUT TYPE=TEXT NAME=war_fname>";
				//echo "</TD> \n";
	 
				echo "<TR><TD class=tdls>\n";
				echo "Last Name";
				echo "</TD><TD> \n";
				echo "<INPUT TYPE=TEXT NAME=war_lname>";
				echo "</TD> \n";
	 
				echo "<TR><TD class=tdcs COLSPAN=2>\n";
				echo "-&nbsp;OR&nbsp;-";
				echo "</TD> \n";

				echo "<TR><TD class=tdls>\n";
				echo "Email";
				echo "</TD><TD> \n";
				echo "<INPUT TYPE=TEXT NAME=war_email>";
				echo "</TD> \n";
	 
				echo "</TABLE>\n";
	
				echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$igid>\n";
				echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"New Initiated Member\">\n";
				echo "</FORM>\n";
	
			echo "</TD><TD ALIGN=CENTER>\n";

				echo "<P class=trace>";
				echo "Enter last name or email and ";
				echo "<BR>click <I>New UnInitiated Member</I> button.";
				echo "<BR>For more information, see";
				echo "<A HREF=/help.php?table_name=igvisitor&field_name=Add&Action=Help>";
				echo " help</A>.</P>\n";

				echo "<FORM ACTION=$_SERVER[PHP_SELF] TYPE=POST>\n";
				echo "<TABLE BORDER=3 id=add_visitor_query_form>\n";
				echo "<TH COLSPAN=2>Add Non-Warrior as New Member or Visitor</TH>\n";
				//echo "<TR><TD class=tdls>\n";
				//echo "First Name";
				//echo "</TD><TD> \n";
				//echo "<INPUT TYPE=TEXT NAME=igvisitor_fname>";
				//echo "</TD> \n";
	 
				echo "<TR><TD class=tdls>\n";
				echo "Last Name";
				echo "</TD><TD> \n";
				echo "<INPUT TYPE=TEXT NAME=igvisitor_lname>";
				echo "</TD> \n";
	 
				echo "<TR><TD class=tdcs COLSPAN=2>\n";
				echo "-&nbsp;OR&nbsp;-";
				echo "</TD> \n";

				echo "<TR><TD class=tdls>\n";
				echo "Email";
				echo "</TD><TD> \n";
				echo "<INPUT TYPE=TEXT NAME=igvisitor_email>";
				echo "</TD> \n";
	 
				echo "</TABLE>\n";
	
				echo "<INPUT TYPE=HIDDEN NAME=igroup_id VALUE=$igid>\n";
				echo "<INPUT TYPE=SUBMIT NAME=Action VALUE=\"New UnInitiated Member\">\n";
				echo "</FORM>\n";

			echo "</TD>\n";
			echo "</TABLE>\n";
		}
	}
	//----------------------------------------------------------------
	// End functions
	//----------------------------------------------------------------


?>
